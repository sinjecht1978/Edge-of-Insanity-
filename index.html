<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cards Game - Mobile Friendly</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            display: none;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .screen.active {
            display: block;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        
        .mobile-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            text-align: center;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
            color: #333;
        }
        
        .game-code {
            font-size: 24px;
            font-weight: bold;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            margin: 10px 0;
            letter-spacing: 3px;
            text-align: center;
            width: 100%;
        }
        
        .card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            touch-action: manipulation;
            user-select: none;
        }
        
        .card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.2);
        }
        
        .card:active {
            transform: translateY(-1px);
        }
        
        .card.selected {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #cccccc;
        }
        
        .card.disabled:hover {
            transform: none;
            border-color: #cccccc;
            box-shadow: none;
        }
        
        .card.black {
            background: #333;
            color: white;
            border-color: #222;
            padding: 20px;
            font-size: 20px;
            text-align: center;
            margin: 20px 0;
            width: 100%;
            cursor: default;
        }
        
        .hand-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 12px;
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .card-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 12px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .player-card {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            font-size: 14px;
            cursor: default;
        }
        
        .player-card.host::after {
            content: "üëë";
            position: absolute;
            top: -8px;
            right: -8px;
            background: gold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .player-card.judge::after {
            content: "‚öñÔ∏è";
            position: absolute;
            top: -8px;
            left: -8px;
            background: #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .player-card.host.judge::after {
            content: "üëë‚öñÔ∏è";
            width: 32px;
            left: -12px;
        }
        
        .score-display {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            min-height: 44px;
        }
        
        .form-control:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .blank-button {
            background: #f5f5f5;
            border: 2px dashed #667eea;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            min-height: 44px;
            user-select: none;
        }
        
        .blank-button:hover {
            background: #eef2ff;
        }
        
        .blank-button:active {
            transform: translateY(0);
        }
        
        .blank-counter {
            color: #667eea;
            font-weight: bold;
            font-size: 16px;
        }
        
        .judge-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .judge-options {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        .judge-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
            user-select: none;
        }
        
        .judge-option:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.2);
        }
        
        .judge-option:active {
            transform: translateY(-1px);
        }
        
        .review-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .review-section {
                flex-direction: row;
            }
        }
        
        .review-column {
            flex: 1;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .review-item {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .review-item:hover {
            border-color: #667eea;
        }
        
        .review-item.selected {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .review-item.disabled {
            opacity: 0.5;
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .collection-controls {
            display: flex;
            gap: 8px;
        }
        
        .collection-controls button {
            padding: 4px 8px;
            font-size: 12px;
            min-height: 30px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            user-select: none;
        }
        
        .collection-controls button:hover {
            opacity: 0.9;
        }
        
        .collection-controls button:active {
            transform: translateY(0);
        }
        
        .collection-controls .btn-enable {
            background: #4CAF50;
            color: white;
        }
        
        .collection-controls .btn-disable {
            background: #ff9800;
            color: white;
        }
        
        .collection-controls .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .deck-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .game-status {
            margin: 15px 0;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .action-buttons .btn {
            width: auto;
            min-width: 140px;
            flex: 1;
        }
        
        .winner-announcement {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 15px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .points-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
        }
        
        .point-item {
            text-align: center;
            min-width: 80px;
        }
        
        .point-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .point-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 20px 0;
        }
        
        .tab-button {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            position: relative;
            flex: 1;
            text-align: center;
            user-select: none;
        }
        
        .tab-button:hover {
            background: #f5f5f5;
        }
        
        .tab-button.active {
            color: #667eea;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .multi-blank-answer {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .blank-answer-part {
            padding: 8px;
            margin: 5px 0;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .blank-number {
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
        }
        
        .selection-counter {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .multi-select-instructions {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 4px solid #4CAF50;
        }
        
        .selected-cards-list {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px dashed #667eea;
        }
        
        .selected-card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            margin: 4px 0;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .remove-selection {
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
            user-select: none;
        }
        
        .remove-selection:hover {
            opacity: 0.9;
        }
        
        .dev-tools-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            user-select: none;
        }
        
        .dev-tools-btn:hover {
            transform: scale(1.1);
        }
        
        .dev-tools-btn:active {
            transform: scale(1);
        }
        
        .remote-help-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            user-select: none;
        }
        
        .remote-help-btn:hover {
            transform: scale(1.1);
        }
        
        .remote-help-btn:active {
            transform: scale(1);
        }
        
        .quick-play-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            text-align: center;
        }
        
        /* Account system styles */
        .account-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 400px;
            width: 90%;
            display: none;
        }
        
        .account-modal.active {
            display: block;
        }
        
        .account-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .account-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            user-select: none;
        }
        
        .account-tab:hover {
            background: #f5f5f5;
        }
        
        .account-tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .account-content {
            display: none;
        }
        
        .account-content.active {
            display: block;
        }
        
        /* Small window for card creation */
        .card-create-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            max-width: 350px;
            width: 90%;
            display: none;
        }
        
        .card-create-window.active {
            display: block;
        }
        
        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .window-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            user-select: none;
        }
        
        .window-close:hover {
            color: #333;
        }
        
        /* Protected collection styles */
        .protected-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        
        .protected-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .protected-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ffd93d;
        }
        
        /* Player list & chat panel */
        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .side-panel.active {
            transform: translateX(0);
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .panel-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .panel-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }
        
        .panel-tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .panel-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .tab-pane {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }
        
        .tab-pane.active {
            display: flex;
        }
        
        .players-tab {
            padding: 15px;
            overflow-y: auto;
        }
        
        .player-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .player-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #667eea;
            color: white;
        }
        
        .player-badge.host {
            background: #FFD700;
            color: #333;
        }
        
        .player-badge.judge {
            background: #4CAF50;
            color: white;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-message {
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-message.own {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }
        
        .chat-message.other {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Timer styles */
        .timer-container {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .timer.warning {
            color: #ff9800;
        }
        
        .timer.danger {
            color: #f44336;
            animation: pulse 1s infinite;
        }
        
        .panel-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 998;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            user-select: none;
        }
        
        /* Mobile specific optimizations */
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .screen {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .game-code {
                font-size: 20px;
                padding: 8px 16px;
            }
            
            .hand-container {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }
            
            .card {
                padding: 12px;
                margin: 8px 0;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
                min-height: 40px;
            }
            
            .tab-button {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .dev-tools-btn,
            .remote-help-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                bottom: 15px;
                right: 15px;
            }
            
            .remote-help-btn {
                bottom: 65px;
            }
            
            .card-create-window {
                padding: 15px;
            }
            
            .side-panel {
                width: 100%;
            }
            
            .panel-toggle {
                width: 40px;
                height: 40px;
                font-size: 16px;
                top: 15px;
                right: 15px;
            }
        }
        
        /* iPhone SE and small phones */
        @media (max-width: 375px) {
            body {
                padding: 5px;
            }
            
            .container {
                min-height: calc(100vh - 10px);
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .badge {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .game-code {
                font-size: 18px;
                letter-spacing: 2px;
            }
        }
        
        /* PC mouse support enhancements */
        .clickable {
            cursor: pointer;
        }
        
        .no-select {
            user-select: none;
        }
        
        /* Focus states for keyboard navigation */
        button:focus,
        input:focus,
        textarea:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Review item checkbox style */
        .review-checkbox {
            margin-right: 10px;
        }
        
        .review-item-content {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with navigation -->
        <div class="header">
            <div class="header-content">
                <h1 id="headerTitle">Cards Game</h1>
                <div class="mobile-nav">
                    <button class="btn btn-secondary" onclick="showAccountModal()" id="accountBtn" style="padding: 8px 12px; font-size: 12px;">
                        Account
                    </button>
                    <button class="btn btn-secondary" onclick="showScreen('menu')" id="menuBtn" style="display: none; padding: 8px 12px; font-size: 12px;">
                        Menu
                    </button>
                    <button class="btn btn-danger" onclick="leaveGame()" id="quitBtn" style="display: none; padding: 8px 12px; font-size: 12px;">
                        Quit
                    </button>
                </div>
            </div>
            <div class="user-info">
                <div class="badge" id="usernameBadge">Guest</div>
                <div class="badge" id="scoreBadge">Score: 0</div>
                <div class="badge" id="roundBadge">Round: 1</div>
                <div class="badge" id="playersBadge">Players: 1</div>
            </div>
        </div>
        
        <!-- Screen 1: Main Menu -->
        <div id="menuScreen" class="screen active">
            <div style="max-width: 100%; margin: 30px auto; text-align: center;">
                <h2 style="font-size: 28px; margin-bottom: 20px; color: #333;">Welcome to Cards Game</h2>
                
                <div style="margin: 30px 0;">
                    <input type="text" id="playerName" class="form-control" placeholder="Enter your name" 
                           style="text-align: center; font-size: 16px; max-width: 300px; margin: 0 auto;" 
                           value="Player">
                </div>
                
                <!-- Unified Quick Play Section -->
                <div class="quick-play-section">
                    <h3 style="color: #333; margin-bottom: 15px;">üéÆ Quick Play üéÆ</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                        <button class="btn btn-success" onclick="quickCreateGame()" style="max-width: 250px;">
                            üöÄ Create Game
                        </button>
                        <p style="color: #666; font-size: 13px; margin: 10px 0;">
                            Create a game, share the code with friends!
                        </p>
                        <div style="display: flex; gap: 10px; max-width: 300px; width: 100%;">
                            <input type="text" id="gameCodeInput" class="form-control" placeholder="Enter Game Code" 
                                   style="flex: 1; text-align: center; font-size: 14px;">
                            <button class="btn btn-secondary" onclick="quickJoinGame()" style="width: 80px;">
                                Join
                            </button>
                        </div>
                    </div>
                    <div id="quickGameInfo" style="margin-top: 15px; display: none;">
                        <div class="game-code" id="quickGameCodeDisplay">ABCDEF</div>
                        <button class="btn" onclick="copyGameLink()" style="max-width: 200px; margin-top: 10px;">
                            üìã Copy Invite Link
                        </button>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">
                            Send this code or link to your friends!
                        </p>
                    </div>
                </div>
                
                <!-- Dev Tools Button -->
                <div style="margin-top: 30px;">
                    <button class="btn btn-warning" onclick="showDevTools()" style="max-width: 250px;">
                        üõ†Ô∏è Dev Tools (For Testing)
                    </button>
                </div>
                
                <div style="margin-top: 40px; color: #666; font-size: 14px; padding: 0 10px;">
                    <p><strong>How to Play:</strong></p>
                    <p>‚Ä¢ Type numbers 1-6 or click to select cards</p>
                    <p>‚Ä¢ First to 7 points wins</p>
                    <p>‚Ä¢ Press [+] to create cards during game</p>
                    <p>‚Ä¢ Judge picks the funniest answer</p>
                    <p>‚Ä¢ For multiple blanks, select multiple cards</p>
                    <p>‚Ä¢ Works with mouse, touch, or keyboard</p>
                </div>
            </div>
        </div>
        
        <!-- Screen 2: Game Lobby -->
        <div id="lobbyScreen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Game Lobby</h2>
                <div class="game-code" id="lobbyGameCode">ABCDEF</div>
                <button class="btn btn-secondary" onclick="copyGameLink()" style="max-width: 250px;">
                    Copy Invite Link
                </button>
            </div>
            
            <div class="points-display">
                <div class="point-item">
                    <div class="point-value" id="winningScore">7</div>
                    <div class="point-label">Points to Win</div>
                </div>
                <div class="point-item">
                    <div class="point-value" id="currentRound">1</div>
                    <div class="point-label">Current Round</div>
                </div>
                <div class="point-item">
                    <div class="point-value" id="deckRemaining">0</div>
                    <div class="point-label">Cards Left</div>
                </div>
            </div>
            
            <div class="deck-info">
                <div style="display: flex; justify-content: space-between;">
                    <span>Answer Cards: <span id="answerCardsCount">0</span></span>
                    <span>Question Cards: <span id="questionCardsCount">0</span></span>
                </div>
            </div>
            
            <h3>Players (<span id="playerCount">1</span>)</h3>
            <div id="lobbyPlayers" class="player-list">
                <!-- Players will appear here -->
            </div>
            
            <!-- Timer Settings -->
            <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 10px;">
                <h3>Game Settings</h3>
                <div class="form-group">
                    <label>Time Limit per Round (seconds):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="timeLimitSlider" min="0" max="120" value="45" 
                               style="flex: 1;" oninput="updateTimeLimit()">
                        <span id="timeLimitValue" style="font-weight: bold; min-width: 50px;">45s</span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn" onclick="setTimeLimit(0)" style="flex: 1; padding: 8px; font-size: 12px;">
                            No Limit
                        </button>
                        <button class="btn" onclick="setTimeLimit(30)" style="flex: 1; padding: 8px; font-size: 12px;">
                            30s
                        </button>
                        <button class="btn" onclick="setTimeLimit(60)" style="flex: 1; padding: 8px; font-size: 12px;">
                            60s
                        </button>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 5px;">
                        0 = No time limit (host controls pace)
                    </p>
                </div>
            </div>
            
            <!-- Tabs for lobby features -->
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchLobbyTab('game')">Game Controls</button>
                <button class="tab-button" onclick="switchLobbyTab('collection')">Card Collection</button>
                <button class="tab-button" onclick="switchLobbyTab('create')">Create Cards</button>
            </div>
            
            <!-- Game Controls Tab -->
            <div id="gameTab" class="tab-content active">
                <div id="hostControls" style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="startGame()" style="max-width: 250px;">
                        Start Game
                    </button>
                    <button class="btn btn-warning" onclick="endGamePrematurely()" style="max-width: 250px; margin-top: 10px;">
                        End Game Early
                    </button>
                </div>
                <div id="playerControls" style="margin-top: 20px; text-align: center; display: none;">
                    <p style="color: #666;">Waiting for host to start the game...</p>
                </div>
            </div>
            
            <!-- Card Collection Tab -->
            <div id="collectionTab" class="tab-content">
                <h3>Card Collection</h3>
                <p style="color: #666; font-size: 14px; margin: 10px 0;">
                    Manage your custom cards. Disabled cards won't appear in games.
                </p>
                
                <div style="margin: 15px 0;">
                    <button class="btn btn-secondary" onclick="refreshCollection()" style="max-width: 200px;">
                        Refresh Collection
                    </button>
                    <button class="btn btn-warning" onclick="showProtectedCollectionModal()" style="max-width: 200px; margin-top: 10px;">
                        üîí Protected Collection
                    </button>
                </div>
                
                <!-- Protected Collection Section -->
                <div class="protected-section" id="protectedCollectionSection" style="display: none;">
                    <div class="protected-badge">PROTECTED</div>
                    <h4>Protected Cards</h4>
                    <p style="color: #666; font-size: 12px; margin: 5px 0;">
                        These cards require a password to modify
                    </p>
                    <div class="protected-controls">
                        <button class="btn btn-secondary" onclick="showPasswordModal('unlock')" style="max-width: 150px; font-size: 12px;">
                            Unlock to Edit
                        </button>
                    </div>
                </div>
                
                <h4>Answer Cards</h4>
                <div id="answerCollection" style="margin: 15px 0; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                    <!-- Answer cards will appear here -->
                </div>
                
                <h4>Question Cards</h4>
                <div id="questionCollection" style="margin: 15px 0; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                    <!-- Question cards will appear here -->
                </div>
            </div>
            
            <!-- Create Cards Tab -->
            <div id="createTab" class="tab-content">
                <h3>Create New Cards (Host Only)</h3>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showCardCreateWindow('answer')">
                        [+] Add Answer Card
                    </button>
                    <button class="btn btn-secondary" onclick="showCardCreateWindow('question')">
                        [?] Add Question Card
                    </button>
                </div>
                <p style="color: #666; font-size: 12px; text-align: center; margin-top: 10px;">
                    Cards created here will be added to the deck and saved to your collection
                </p>
            </div>
        </div>
        
        <!-- Screen 3: Game Screen -->
        <div id="gameScreen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Round <span id="roundNumber">1</span></h2>
                <div class="timer-container">
                    <div id="timerDisplay" class="timer">--:--</div>
                    <div id="timerLabel" style="color: #666; font-size: 12px;">Time remaining</div>
                </div>
                <div class="game-status">
                    <strong>Status:</strong> <span id="statusText">Waiting for game to start...</span>
                </div>
                <div id="judgeIndicator" style="margin: 10px 0; padding: 8px 15px; background: #4CAF50; color: white; border-radius: 20px; display: inline-block; font-size: 14px;">
                    ‚öñÔ∏è Judge: <span id="currentJudgeName">Loading...</span>
                </div>
            </div>
            
            <!-- Question Display -->
            <div class="card black" id="questionDisplay">
                What's that smell? _____
            </div>
            
            <!-- Multi-blank selection display -->
            <div id="multiBlankInstructions" class="multi-select-instructions" style="display: none;">
                <strong>Multiple Blanks Detected!</strong> 
                <p style="margin-top: 5px; font-size: 13px;">
                    Select <span id="requiredCardsCount">1</span> card(s) for the blanks. 
                    Selected cards will be combined in order.
                </p>
            </div>
            
            <!-- Selected cards display -->
            <div id="selectedCardsDisplay" class="selected-cards-list" style="display: none;">
                <h4>Selected Cards (<span id="selectedCount">0</span> of <span id="totalRequired">1</span>):</h4>
                <div id="selectedCardsList">
                    <!-- Selected cards will appear here -->
                </div>
            </div>
            
            <!-- Hand Display -->
            <h3>Your Hand (Click cards or type 1-6 to select):</h3>
            <div class="hand-container" id="playerHand">
                <!-- Cards will appear here -->
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn" onclick="submitCard()" id="submitBtn" disabled>
                    Submit Card<span id="submitCount" class="selection-counter" style="display: none;"></span>
                </button>
                <button class="btn btn-secondary" onclick="showCardCreateWindow('answer')">
                    [+] Create Card
                </button>
                <button class="btn btn-secondary" onclick="showCardCreateWindow('question')">
                    [?] Create Question
                </button>
                <button class="btn btn-warning" onclick="clearSelections()" id="clearBtn" style="display: none;">
                    Clear Selections
                </button>
            </div>
            
            <!-- Score Display -->
            <div class="points-display">
                <div class="point-item">
                    <div class="point-value" id="playerScore">0</div>
                    <div class="point-label">Your Score</div>
                </div>
                <div class="point-item">
                    <div class="point-value">7</div>
                    <div class="point-label">Points to Win</div>
                </div>
                <div class="point-item">
                    <div class="point-value" id="cardsInHand">6</div>
                    <div class="point-label">Cards in Hand</div>
                </div>
            </div>
        </div>
        
        <!-- Screen 4: Judging Screen -->
        <div id="judgingScreen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Judge Selection</h2>
                <div class="card black" id="judgeQuestion">
                    What's that smell? _____
                </div>
                <p style="margin: 15px 0; font-size: 16px; color: #666;">
                    Select the best answer:
                </p>
                <div style="color: #4CAF50; font-weight: bold; padding: 8px 15px; background: #e8f5e9; border-radius: 20px; display: inline-block;">
                    ‚öñÔ∏è You are the Judge
                </div>
            </div>
            
            <!-- Options Display -->
            <div class="judge-options" id="judgeOptions">
                <!-- Options will appear here -->
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="returnToLobby()">
                    Return to Lobby
                </button>
            </div>
        </div>
        
        <!-- Screen 5: Winner Screen -->
        <div id="winnerScreen" class="screen">
            <div class="winner-announcement">
                <h2>üéâ Round Winner! üéâ</h2>
                <div id="winnerDetails" style="margin: 20px 0; font-size: 18px;">
                    <!-- Winner details will appear here -->
                </div>
            </div>
            
            <div class="points-display">
                <div class="point-item">
                    <div class="point-value" id="winnerScore">0</div>
                    <div class="point-label">Winner's Score</div>
                </div>
                <div class="point-item">
                    <div class="point-value" id="roundsPlayed">1</div>
                    <div class="point-label">Rounds Played</div>
                </div>
                <div class="point-item">
                    <div class="point-value" id="deckSize">0</div>
                    <div class="point-label">Cards Left</div>
                </div>
            </div>
            
            <div id="gameWinnerAnnouncement" style="display: none;">
                <div class="winner-announcement" style="background: linear-gradient(135deg, #FFD700 0%, #FF6B6B 100%);">
                    <h2>üèÜ GAME WINNER! üèÜ</h2>
                    <div id="gameWinnerDetails" style="margin: 20px 0; font-size: 20px;"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="continueToNextRound()" id="nextRoundBtn">
                    Next Round
                </button>
                <button class="btn" onclick="returnToLobby()">
                    Return to Lobby
                </button>
                <button class="btn btn-secondary" onclick="showReviewScreen()" id="reviewBtn" style="display: none;">
                    Review Created Cards
                </button>
            </div>
        </div>
        
        <!-- Screen 6: Review Screen -->
        <div id="reviewScreen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Card Review</h2>
                <p style="color: #666; margin-top: 10px;">
                    Select cards to delete (cards are already in your collection)
                </p>
            </div>
            
            <div class="review-section">
                <div class="review-column">
                    <h3>Questions</h3>
                    <div id="reviewQuestions">
                        <!-- Questions for review -->
                    </div>
                </div>
                
                <div class="review-column">
                    <h3>Answers</h3>
                    <div id="reviewAnswers">
                        <!-- Answers for review -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="keepAllCards()">
                    Keep All Cards
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedCards()" id="deleteSelectedBtn" disabled>
                    Delete Selected
                </button>
                <button class="btn btn-warning" onclick="deleteAllCreatedCardsReview()">
                    Delete All Created Cards
                </button>
                <button class="btn" onclick="returnToLobby()">
                    Back to Lobby
                </button>
            </div>
        </div>
    </div>
    
    <!-- Player List & Chat Panel -->
    <button class="panel-toggle" onclick="togglePanel()" id="panelToggle">üë•</button>
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <h3 style="margin: 0; font-size: 18px;">Players & Chat</h3>
            <button class="panel-close" onclick="togglePanel()">√ó</button>
        </div>
        <div class="panel-tabs">
            <button class="panel-tab active" onclick="switchPanelTab('players')">Players</button>
            <button class="panel-tab" onclick="switchPanelTab('chat')">Chat</button>
        </div>
        <div class="panel-content">
            <!-- Players Tab -->
            <div id="playersTab" class="tab-pane active">
                <div class="players-tab">
                    <h4>Connected Players (<span id="panelPlayerCount">0</span>)</h4>
                    <div id="panelPlayerList">
                        <!-- Players will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Chat Tab -->
            <div id="chatTab" class="tab-pane">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            Welcome to the chat!
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                        <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Account Modal -->
    <div id="accountModal" class="account-modal">
        <div class="account-tabs">
            <button class="account-tab active" onclick="switchAccountTab('login')">Login</button>
            <button class="account-tab" onclick="switchAccountTab('register')">Register</button>
        </div>
        
        <div id="loginTab" class="account-content active">
            <h3 style="text-align: center; margin-bottom: 20px;">Login to Your Account</h3>
            <div class="form-group">
                <input type="text" id="loginUsername" class="form-control" placeholder="Username">
            </div>
            <div class="form-group">
                <input type="password" id="loginPassword" class="form-control" placeholder="Password">
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="hideAccountModal()">Cancel</button>
            </div>
        </div>
        
        <div id="registerTab" class="account-content">
            <h3 style="text-align: center; margin-bottom: 20px;">Create New Account</h3>
            <div class="form-group">
                <input type="text" id="registerUsername" class="form-control" placeholder="Choose Username">
            </div>
            <div class="form-group">
                <input type="password" id="registerPassword" class="form-control" placeholder="Choose Password">
            </div>
            <div class="form-group">
                <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirm Password">
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="hideAccountModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Card Creation Window -->
    <div id="cardCreateWindow" class="card-create-window">
        <div class="window-header">
            <h3 id="windowTitle">Create Card</h3>
            <button class="window-close" onclick="hideCardCreateWindow()">√ó</button>
        </div>
        <div class="form-group">
            <textarea id="cardCreateText" class="form-control" rows="3" 
                      placeholder="Enter your card text here..."></textarea>
        </div>
        <div id="blankControls" style="display: none;">
            <label>Blanks: <span class="blank-counter" id="createBlankCount">1</span></label>
            <div style="text-align: center; margin-top: 10px;">
                <button class="blank-button" onclick="addCreateBlank()">
                    + Add Blank [_]
                </button>
                <button class="blank-button" onclick="removeCreateBlank()">
                    - Remove Blank
                </button>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn" onclick="submitCreatedCard()">
                Create Card
            </button>
        </div>
    </div>
    
    <!-- Password Protected Collection Modal -->
    <div id="protectedCollectionModal" class="modal">
        <div class="modal-content">
            <h2>üîí Protected Collection</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Enter password to access protected cards:
            </p>
            <div class="form-group">
                <input type="password" id="collectionPassword" class="form-control" placeholder="Password">
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="accessProtectedCollection()">
                    Access
                </button>
                <button class="btn btn-secondary" onclick="hideModal('protectedCollectionModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        let gameState = {
            playerName: "Player",
            gameCode: null,
            isHost: false,
            players: [],
            currentRound: 1,
            hand: [],
            selectedCards: [],
            gamePhase: "menu",
            isJudge: false,
            deck: [], // Current playable answer cards
            questionDeck: [], // Current playable question cards
            allAnswers: [], // Master collection of all answer cards
            allQuestions: [], // Master collection of all question cards
            submittedCards: [],
            cardsToReview: [],
            createdCards: [],
            scores: {},
            winningScore: 7,
            maxRounds: 10,
            cardCollection: {
                answers: [],
                questions: [],
                protectedPassword: "admin123", // Password for default cards
                protectedUnlocked: false
            },
            usedQuestions: [], // Questions used in current session
            usedAnswers: [], // Answers used in current session
            currentBlankCount: 1,
            activeQuestion: null,
            gameWinner: null,
            currentUser: null,
            
            // NEW: Time management
            timeLimit: 45, // seconds, 0 = no time limit
            timerRunning: false,
            timeLeft: 45,
            timerInterval: null,
            
            // NEW: Player management
            currentJudgeIndex: 0, // Index in players array of current judge
            roundStarted: false,
            
            // NEW: Player session management
            playerId: null, // Current player's unique ID
            
            // NEW: Chat messages
            chatMessages: []
        };
        
        // ==================== DEFAULT CARDS ====================
        const DEFAULT_ANSWERS = [
            "A fart so powerful it wakes the dead.",
            "My weird uncle.",
            "Getting drunk on mouthwash.",
            "The miracle of childbirth.",
            "Peeing a little bit.",
            "A lifetime of regrets.",
            "Forgetting to wear pants.",
            "Selling my soul for internet fame.",
            "A suspicious rash.",
            "Cheating at Scrabble."
        ];
        
        const DEFAULT_QUESTIONS = [
            "What's that smell? _____",
            "What ruined the bachelor party? _____",
            "What's Grandpa hiding in the attic? _____",
            "What's the secret to a happy marriage? _____",
            "What did I bring back from Mexico? _____"
        ];
        
        // ==================== ACCOUNT SYSTEM ====================
        function showAccountModal() {
            document.getElementById('accountModal').classList.add('active');
        }
        
        function hideAccountModal() {
            document.getElementById('accountModal').classList.remove('active');
        }
        
        function switchAccountTab(tabId) {
            document.querySelectorAll('.account-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.account-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchAccountTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
        }
        
        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !password) {
                alert("Please enter username and password");
                return;
            }
            
            if (password !== confirmPassword) {
                alert("Passwords do not match");
                return;
            }
            
            if (username.length < 3) {
                alert("Username must be at least 3 characters");
                return;
            }
            
            if (password.length < 6) {
                alert("Password must be at least 6 characters");
                return;
            }
            
            // Check if user already exists
            const existingUsers = JSON.parse(localStorage.getItem('cardGameUsers') || '{}');
            if (existingUsers[username]) {
                alert("Username already exists");
                return;
            }
            
            // Create user account with default collection
            const userData = {
                username: username,
                password: btoa(password), // Simple encoding
                collection: {
                    answers: DEFAULT_ANSWERS.map(text => ({
                        text: text,
                        enabled: true,
                        isDefault: true,
                        isProtected: true
                    })),
                    questions: DEFAULT_QUESTIONS.map(text => ({
                        text: text,
                        enabled: true,
                        isDefault: true,
                        isProtected: true
                    })),
                    protectedPassword: "admin123",
                    protectedUnlocked: false
                },
                createdAt: new Date().toISOString()
            };
            
            existingUsers[username] = userData;
            localStorage.setItem('cardGameUsers', JSON.stringify(existingUsers));
            
            // Auto login
            gameState.currentUser = username;
            gameState.cardCollection = userData.collection;
            saveCardCollection();
            
            document.getElementById('usernameBadge').textContent = username;
            hideAccountModal();
            alert(`Account created successfully! Welcome ${username}`);
        }
        
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert("Please enter username and password");
                return;
            }
            
            const existingUsers = JSON.parse(localStorage.getItem('cardGameUsers') || '{}');
            const userData = existingUsers[username];
            
            if (!userData) {
                alert("User not found");
                return;
            }
            
            if (btoa(password) !== userData.password) {
                alert("Incorrect password");
                return;
            }
            
            gameState.currentUser = username;
            gameState.cardCollection = userData.collection;
            saveCardCollection();
            
            document.getElementById('usernameBadge').textContent = username;
            hideAccountModal();
            alert(`Welcome back ${username}!`);
        }
        
        function logout() {
            gameState.currentUser = null;
            document.getElementById('usernameBadge').textContent = "Guest";
            alert("Logged out successfully");
        }
        
        // ==================== CARD CREATION WINDOW ====================
        let currentCardType = 'answer';
        
        function showCardCreateWindow(type) {
            currentCardType = type;
            const window = document.getElementById('cardCreateWindow');
            const title = document.getElementById('windowTitle');
            const textarea = document.getElementById('cardCreateText');
            const blankControls = document.getElementById('blankControls');
            
            if (type === 'question') {
                title.textContent = "Create Question Card";
                textarea.placeholder = "Enter your question with _____ for blanks";
                blankControls.style.display = 'block';
                document.getElementById('createBlankCount').textContent = '1';
                textarea.value = '';
            } else {
                title.textContent = "Create Answer Card";
                textarea.placeholder = "Enter your answer card text...";
                blankControls.style.display = 'none';
                textarea.value = '';
            }
            
            window.classList.add('active');
        }
        
        function hideCardCreateWindow() {
            document.getElementById('cardCreateWindow').classList.remove('active');
        }
        
        function addCreateBlank() {
            const textarea = document.getElementById('cardCreateText');
            const blankCount = document.getElementById('createBlankCount');
            textarea.value = textarea.value + ' _____';
            blankCount.textContent = parseInt(blankCount.textContent) + 1;
        }
        
        function removeCreateBlank() {
            const textarea = document.getElementById('cardCreateText');
            const blankCount = document.getElementById('createBlankCount');
            const text = textarea.value;
            
            if (parseInt(blankCount.textContent) <= 1) return;
            
            const lastBlankIndex = text.lastIndexOf('_____');
            if (lastBlankIndex !== -1) {
                textarea.value = text.substring(0, lastBlankIndex).trim();
                blankCount.textContent = parseInt(blankCount.textContent) - 1;
            }
        }
        
        function submitCreatedCard() {
            const cardText = document.getElementById('cardCreateText').value.trim();
            
            if (!cardText) {
                alert("Please enter card text");
                return;
            }
            
            if (currentCardType === 'answer') {
                // Add to collection (always)
                gameState.cardCollection.answers.push({
                    text: cardText,
                    enabled: true,
                    isDefault: false,
                    isProtected: false
                });
                
                // Add to current deck if in game
                if (gameState.deck) {
                    const randomPosition = Math.floor(Math.random() * gameState.deck.length);
                    gameState.deck.splice(randomPosition, 0, cardText);
                    
                    // Add to hand if playing
                    if (gameState.hand && gameState.hand.length < 6) {
                        const handPosition = Math.floor(Math.random() * gameState.hand.length);
                        gameState.hand.splice(handPosition, 0, cardText);
                        updatePlayerHand();
                    }
                }
            } else {
                // Add question to collection (always)
                gameState.cardCollection.questions.push({
                    text: cardText,
                    enabled: true,
                    isDefault: false,
                    isProtected: false
                });
                
                // Add to current question deck if in game
                if (gameState.questionDeck) {
                    const randomPosition = Math.floor(Math.random() * gameState.questionDeck.length);
                    gameState.questionDeck.splice(randomPosition, 0, cardText);
                }
            }
            
            // Track for review screen
            gameState.createdCards.push(cardText);
            
            // Save collection
            saveCardCollection();
            
            // Close window and show success
            hideCardCreateWindow();
            
            // Update UI if in lobby
            if (document.querySelector('.screen.active').id === 'lobbyScreen') {
                refreshCollection();
                updateDeckInfo();
            }
            
            // Update review button if on winner screen
            const reviewBtn = document.getElementById('reviewBtn');
            if (reviewBtn) {
                reviewBtn.style.display = 'inline-flex';
                reviewBtn.textContent = `Review Created Cards (${gameState.createdCards.length})`;
            }
            
            // Show success message
            alert(`Card created successfully!\n\nAdded to your collection and ${currentCardType === 'answer' ? 'answer' : 'question'} deck.\n\nYou can review/delete it later from the review screen.`);
        }
        
        // ==================== PROTECTED COLLECTION ====================
        function showProtectedCollectionModal() {
            showModal('protectedCollectionModal');
        }
        
        function accessProtectedCollection() {
            const password = document.getElementById('collectionPassword').value;
            
            if (password === gameState.cardCollection.protectedPassword) {
                gameState.cardCollection.protectedUnlocked = true;
                hideModal('protectedCollectionModal');
                refreshCollection();
                alert("Default cards unlocked! You can now edit them.");
            } else {
                alert("Incorrect password");
            }
        }
        
        // ==================== REVIEW SCREEN ====================
        function showReviewScreen() {
            // Check if there are any created cards
            if (gameState.createdCards.length === 0) {
                alert("No cards were created during this game.");
                returnToLobby();
                return;
            }
            
            const questionsContainer = document.getElementById('reviewQuestions');
            const answersContainer = document.getElementById('reviewAnswers');
            
            questionsContainer.innerHTML = '';
            answersContainer.innerHTML = '';
            
            // Separate questions and answers from created cards
            const createdQuestions = [];
            const createdAnswers = [];
            
            gameState.createdCards.forEach(cardText => {
                if (cardText.includes('_____')) {
                    createdQuestions.push(cardText);
                } else {
                    createdAnswers.push(cardText);
                }
            });
            
            // Display created questions for review
            if (createdQuestions.length > 0) {
                createdQuestions.forEach((question, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'review-item';
                    itemDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <input type="checkbox" class="review-checkbox" id="question-${index}" onchange="updateDeleteButton()">
                            <div class="review-item-content">${question}</div>
                        </div>
                    `;
                    questionsContainer.appendChild(itemDiv);
                });
            } else {
                questionsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No questions created</p>';
            }
            
            // Display created answers for review
            if (createdAnswers.length > 0) {
                createdAnswers.forEach((answer, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'review-item';
                    itemDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <input type="checkbox" class="review-checkbox" id="answer-${index}" onchange="updateDeleteButton()">
                            <div class="review-item-content">${answer}</div>
                        </div>
                    `;
                    answersContainer.appendChild(itemDiv);
                });
            } else {
                answersContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No answers created</p>';
            }
            
            // Update delete button state
            updateDeleteButton();
            
            showScreen('review');
        }
        
        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.review-checkbox');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            let anyChecked = false;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    anyChecked = true;
                }
            });
            
            deleteBtn.disabled = !anyChecked;
        }
        
        function keepAllCards() {
            // Just clear the created cards array and return to lobby
            gameState.createdCards = [];
            alert("All cards kept in your collection!");
            returnToLobby();
        }
        
        function deleteSelectedCards() {
            const checkboxes = document.querySelectorAll('.review-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert("No cards selected for deletion");
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${checkboxes.length} selected card(s) from your collection?`)) {
                return;
            }
            
            // Get the text of selected cards
            const cardsToDelete = [];
            checkboxes.forEach(checkbox => {
                const itemDiv = checkbox.closest('.review-item');
                const cardText = itemDiv.querySelector('.review-item-content').textContent;
                cardsToDelete.push(cardText);
            });
            
            // Remove selected cards from collection
            cardsToDelete.forEach(cardText => {
                // Remove from answers collection
                const answerIndex = gameState.cardCollection.answers.findIndex(card => 
                    card.text === cardText && !card.isDefault
                );
                if (answerIndex !== -1) {
                    gameState.cardCollection.answers.splice(answerIndex, 1);
                }
                
                // Remove from questions collection
                const questionIndex = gameState.cardCollection.questions.findIndex(card => 
                    card.text === cardText && !card.isDefault
                );
                if (questionIndex !== -1) {
                    gameState.cardCollection.questions.splice(questionIndex, 1);
                }
                
                // Remove from createdCards array
                const createdIndex = gameState.createdCards.indexOf(cardText);
                if (createdIndex !== -1) {
                    gameState.createdCards.splice(createdIndex, 1);
                }
            });
            
            // Save collection
            saveCardCollection();
            
            alert(`${cardsToDelete.length} card(s) deleted from your collection.`);
            
            // If all created cards are deleted, return to lobby
            if (gameState.createdCards.length === 0) {
                returnToLobby();
            } else {
                // Refresh the review screen
                showReviewScreen();
            }
        }
        
        function deleteAllCreatedCardsReview() {
            if (gameState.createdCards.length === 0) {
                alert("No cards to delete");
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ALL ${gameState.createdCards.length} created cards from your collection?`)) {
                return;
            }
            
            // Remove ALL created cards from collection
            gameState.createdCards.forEach(cardText => {
                // Remove from answers collection
                const answerIndex = gameState.cardCollection.answers.findIndex(card => 
                    card.text === cardText && !card.isDefault
                );
                if (answerIndex !== -1) {
                    gameState.cardCollection.answers.splice(answerIndex, 1);
                }
                
                // Remove from questions collection
                const questionIndex = gameState.cardCollection.questions.findIndex(card => 
                    card.text === cardText && !card.isDefault
                );
                if (questionIndex !== -1) {
                    gameState.cardCollection.questions.splice(questionIndex, 1);
                }
            });
            
            const deletedCount = gameState.createdCards.length;
            gameState.createdCards = [];
            
            // Save collection
            saveCardCollection();
            
            alert(`${deletedCount} cards deleted from your collection.`);
            returnToLobby();
        }
        
        // ==================== PLAYER JOIN SYSTEM ====================
        function quickCreateGame() {
            const playerName = document.getElementById('playerName').value.trim() || "Host";
            gameState.playerName = playerName;
            gameState.isHost = true;
            
            // Generate unique player ID
            const playerId = generatePlayerId();
            gameState.playerId = playerId;
            
            gameState.gameCode = generateGameCode();
            gameState.players = [{
                name: playerName,
                isHost: true,
                score: 0,
                id: playerId,
                isConnected: true
            }];
            
            // Set as first judge
            gameState.currentJudgeIndex = 0;
            gameState.isJudge = true;
            
            initializeDecks();
            gameState.scores = { [playerId]: 0 };
            gameState.createdCards = [];
            gameState.currentRound = 1;
            gameState.selectedCards = [];
            gameState.gameWinner = null;
            gameState.chatMessages = [];
            
            // Add welcome message
            addSystemChatMessage(`Game created! Code: ${gameState.gameCode}`);
            addSystemChatMessage(`${playerName} created the game and is the host.`);
            
            document.getElementById('quickGameCodeDisplay').textContent = gameState.gameCode;
            document.getElementById('quickGameInfo').style.display = 'block';
            
            // Update UI
            updateGameUI();
            showScreen('lobby');
            
            // Show player panel
            updatePlayerPanel();
            
            alert(`Game created!\n\nGame Code: ${gameState.gameCode}\n\nShare this code with friends!`);
        }
        
        function quickJoinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            const joinCode = document.getElementById('gameCodeInput').value.trim().toUpperCase();
            
            if (!playerName) {
                alert("Please enter your name!");
                return;
            }
            
            if (!joinCode || joinCode.length !== 6) {
                alert("Enter a valid 6-character game code!");
                return;
            }
            
            // Generate unique player ID
            const playerId = generatePlayerId();
            
            gameState.playerName = playerName;
            gameState.gameCode = joinCode;
            gameState.isHost = false;
            gameState.playerId = playerId;
            
            // Create player object
            const newPlayer = {
                name: playerName,
                isHost: false,
                score: 0,
                id: playerId,
                isConnected: true
            };
            
            // Check if we're already in the players list
            if (!gameState.players.find(p => p.id === playerId)) {
                gameState.players.push(newPlayer);
            }
            
            // In a real game, this would come from the server
            // For simulation, set judge randomly
            gameState.currentJudgeIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.isJudge = (gameState.currentJudgeIndex === gameState.players.length - 1);
            
            gameState.scores[playerId] = 0;
            gameState.createdCards = [];
            gameState.selectedCards = [];
            gameState.chatMessages = [];
            
            // Add join message
            addSystemChatMessage(`${playerName} joined the game!`);
            
            updateGameUI();
            showScreen('lobby');
            
            // Show player panel
            updatePlayerPanel();
            
            alert(`Joining game ${joinCode} as ${playerName}!\n\nWaiting for host to start...`);
        }
        
        function generateGameCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ==================== INITIALIZATION ====================
        function initializeCardCollection() {
            if (gameState.currentUser) {
                // Load from user account
                const users = JSON.parse(localStorage.getItem('cardGameUsers') || '{}');
                if (users[gameState.currentUser]) {
                    gameState.cardCollection = users[gameState.currentUser].collection;
                } else {
                    createDefaultCollection();
                }
            } else {
                // Load from local storage
                const savedCollection = localStorage.getItem('cardCollection');
                if (savedCollection) {
                    gameState.cardCollection = JSON.parse(savedCollection);
                } else {
                    createDefaultCollection();
                }
            }
        }
        
        function createDefaultCollection() {
            gameState.cardCollection = {
                answers: DEFAULT_ANSWERS.map(text => ({
                    text: text,
                    enabled: true,
                    isDefault: true,
                    isProtected: true
                })),
                questions: DEFAULT_QUESTIONS.map(text => ({
                    text: text,
                    enabled: true,
                    isDefault: true,
                    isProtected: true
                })),
                protectedPassword: "admin123",
                protectedUnlocked: false
            };
            saveCardCollection();
        }
        
        function saveCardCollection() {
            if (gameState.currentUser) {
                // Save to user account
                const users = JSON.parse(localStorage.getItem('cardGameUsers') || '{}');
                if (users[gameState.currentUser]) {
                    users[gameState.currentUser].collection = gameState.cardCollection;
                    localStorage.setItem('cardGameUsers', JSON.stringify(users));
                }
            }
            localStorage.setItem('cardCollection', JSON.stringify(gameState.cardCollection));
        }
        
        function initializeDecks() {
            const enabledAnswers = gameState.cardCollection.answers
                .filter(card => card.enabled)
                .map(card => card.text);
            
            const enabledQuestions = gameState.cardCollection.questions
                .filter(card => card.enabled)
                .map(card => card.text);
            
            gameState.usedAnswers = [];
            gameState.usedQuestions = [];
            gameState.activeQuestion = null;
            
            gameState.allAnswers = [...enabledAnswers];
            gameState.allQuestions = [...enabledQuestions];
            gameState.deck = shuffleArrayProperly([...enabledAnswers]);
            gameState.questionDeck = shuffleArrayProperly([...enabledQuestions]);
            
            console.log(`Initialized decks: ${gameState.deck.length} answers, ${gameState.questionDeck.length} questions`);
        }
        
        function shuffleArrayProperly(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // ==================== SCREEN MANAGEMENT ====================
        function showScreen(screenId) {
            console.log("Showing screen:", screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const screenElement = document.getElementById(screenId + 'Screen');
            if (screenElement) {
                screenElement.classList.add('active');
                updateHeader(screenId);
                
                if (screenId === 'lobby') {
                    refreshCollection();
                    updateDeckInfo();
                    updatePlayerPanel();
                }
                
                if (screenId === 'game') {
                    updateTimerDisplay();
                }
            }
        }
        
        function switchLobbyTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchLobbyTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
        }
        
        function updateHeader(screenId) {
            const headerTitle = document.getElementById('headerTitle');
            const menuBtn = document.getElementById('menuBtn');
            const quitBtn = document.getElementById('quitBtn');
            
            switch(screenId) {
                case 'menu':
                    headerTitle.textContent = "Cards Game";
                    menuBtn.style.display = 'none';
                    quitBtn.style.display = 'none';
                    break;
                case 'lobby':
                    headerTitle.textContent = "Game Lobby";
                    menuBtn.style.display = 'inline-flex';
                    quitBtn.style.display = 'inline-flex';
                    break;
                case 'game':
                    headerTitle.textContent = `Round ${gameState.currentRound}`;
                    menuBtn.style.display = 'inline-flex';
                    quitBtn.style.display = 'inline-flex';
                    break;
                case 'judging':
                    headerTitle.textContent = "Judging";
                    menuBtn.style.display = 'inline-flex';
                    quitBtn.style.display = 'inline-flex';
                    break;
                case 'winner':
                    headerTitle.textContent = "Round Results";
                    menuBtn.style.display = 'inline-flex';
                    quitBtn.style.display = 'inline-flex';
                    break;
                case 'review':
                    headerTitle.textContent = "Card Review";
                    menuBtn.style.display = 'inline-flex';
                    quitBtn.style.display = 'inline-flex';
                    break;
            }
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showCustomModal(title, content, modalId) {
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div id="${modalId}Content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById(modalId + 'Content').innerHTML = content;
            modal.classList.add('active');
        }
        
        // ==================== PLAYER PANEL & CHAT ====================
        function togglePanel() {
            const panel = document.getElementById('sidePanel');
            panel.classList.toggle('active');
            updatePlayerPanel();
        }
        
        function switchPanelTab(tabId) {
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchPanelTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
        }
        
        function updatePlayerPanel() {
            const playerList = document.getElementById('panelPlayerList');
            const playerCount = document.getElementById('panelPlayerCount');
            
            if (!playerList) return;
            
            playerList.innerHTML = '';
            playerCount.textContent = gameState.players.length;
            
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-list-item';
                
                const isJudge = gameState.currentJudgeIndex !== -1 && 
                               gameState.players[gameState.currentJudgeIndex]?.id === player.id;
                
                playerDiv.innerHTML = `
                    <div class="player-indicator">
                        <span style="font-weight: bold;">${player.name}</span>
                        ${player.isHost ? '<span class="player-badge host">üëë Host</span>' : ''}
                        ${isJudge ? '<span class="player-badge judge">‚öñÔ∏è Judge</span>' : ''}
                    </div>
                    <div style="color: #666; font-size: 12px;">
                        Score: ${gameState.scores[player.id] || 0}
                    </div>
                `;
                
                if (player.id === gameState.playerId) {
                    playerDiv.style.backgroundColor = '#e8f5e9';
                    playerDiv.style.borderLeft = '3px solid #4CAF50';
                }
                
                playerList.appendChild(playerDiv);
            });
            
            // Update chat display
            updateChatDisplay();
        }
        
        function updateChatDisplay() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = '';
            
            gameState.chatMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${msg.type === 'system' ? 'system' : (msg.senderId === gameState.playerId ? 'own' : 'other')}`;
                
                if (msg.type === 'system') {
                    msgDiv.innerHTML = `<em>${msg.text}</em>`;
                    msgDiv.style.fontStyle = 'italic';
                    msgDiv.style.color = '#666';
                    msgDiv.style.backgroundColor = '#f5f5f5';
                    msgDiv.style.alignSelf = 'center';
                } else {
                    const sender = gameState.players.find(p => p.id === msg.senderId);
                    const senderName = sender ? sender.name : 'Unknown';
                    msgDiv.innerHTML = `<strong>${senderName}:</strong> ${msg.text}`;
                }
                
                chatMessages.appendChild(msgDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addSystemChatMessage(text) {
            gameState.chatMessages.push({
                type: 'system',
                text: text,
                timestamp: new Date().toISOString()
            });
            updateChatDisplay();
        }
        
        function addChatMessage(senderId, text) {
            gameState.chatMessages.push({
                type: 'player',
                senderId: senderId,
                text: text,
                timestamp: new Date().toISOString()
            });
            updateChatDisplay();
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(gameState.playerId, message);
            input.value = '';
            
            // In a real multiplayer game, this would be sent to the server
            // For now, we'll just display it locally
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        // ==================== TIMER FUNCTIONS ====================
        function updateTimeLimit() {
            const slider = document.getElementById('timeLimitSlider');
            const value = document.getElementById('timeLimitValue');
            const timeLimit = parseInt(slider.value);
            
            gameState.timeLimit = timeLimit;
            value.textContent = timeLimit > 0 ? timeLimit + 's' : 'No limit';
        }
        
        function setTimeLimit(seconds) {
            const slider = document.getElementById('timeLimitSlider');
            slider.value = seconds;
            updateTimeLimit();
        }
        
        function startTimer() {
            if (gameState.timeLimit <= 0) {
                document.getElementById('timerDisplay').textContent = '--:--';
                return;
            }
            
            stopTimer();
            
            gameState.timeLeft = gameState.timeLimit;
            gameState.timerRunning = true;
            
            updateTimerDisplay();
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    stopTimer();
                    timeUp();
                }
            }, 1000);
        }
        
        function stopTimer() {
            gameState.timerRunning = false;
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            if (!timerDisplay) return;
            
            if (gameState.timeLimit <= 0) {
                timerDisplay.textContent = '--:--';
                timerDisplay.className = 'timer';
                return;
            }
            
            if (!gameState.timerRunning) {
                timerDisplay.textContent = '--:--';
                timerDisplay.className = 'timer';
                return;
            }
            
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update timer color based on time remaining
            if (gameState.timeLeft <= 10) {
                timerDisplay.className = 'timer danger';
            } else if (gameState.timeLeft <= 30) {
                timerDisplay.className = 'timer warning';
            } else {
                timerDisplay.className = 'timer';
            }
        }
        
        function timeUp() {
            if (gameState.gamePhase === 'playing' && !gameState.isJudge) {
                // Auto-submit if time runs out (in a real game, this would be handled by server)
                if (gameState.selectedCards.length > 0) {
                    submitCard();
                } else {
                    // Randomly select a card if none selected
                    if (gameState.hand.length > 0) {
                        const randomIndex = Math.floor(Math.random() * gameState.hand.length);
                        gameState.selectedCards = [randomIndex];
                        submitCard();
                    }
                }
                
                addSystemChatMessage(`Time's up! Auto-submitted for ${gameState.playerName}.`);
            }
        }
        
        // ==================== COLLECTION MANAGEMENT ====================
        function refreshCollection() {
            const answerContainer = document.getElementById('answerCollection');
            const questionContainer = document.getElementById('questionCollection');
            const protectedSection = document.getElementById('protectedCollectionSection');
            
            answerContainer.innerHTML = '';
            questionContainer.innerHTML = '';
            
            // Show protected section if there are protected cards
            const hasProtectedCards = gameState.cardCollection.answers.some(card => card.isProtected) || 
                                     gameState.cardCollection.questions.some(card => card.isProtected);
            protectedSection.style.display = hasProtectedCards ? 'block' : 'none';
            
            // Display answer cards
            gameState.cardCollection.answers.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `card ${card.enabled ? '' : 'disabled'}`;
                if (card.isProtected) {
                    cardDiv.style.borderLeft = '4px solid #ff6b6b';
                    cardDiv.style.background = 'linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%)';
                }
                
                cardDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${card.text}</span>
                        <div class="collection-controls">
                            ${card.isDefault ? `
                                <span style="color: #666; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <span>Default</span>
                                    ${card.isProtected ? 'üîí' : ''}
                                </span>
                            ` : ''}
                            <button class="${card.enabled ? 'btn-disable' : 'btn-enable'}" 
                                    onclick="toggleCardEnabled('answer', ${index})">
                                ${card.enabled ? 'Disable' : 'Enable'}
                            </button>
                            ${!card.isDefault || gameState.cardCollection.protectedUnlocked ? `
                                <button class="btn-delete" 
                                        onclick="deleteCard('answer', ${index})">
                                    Delete
                                </button>
                            ` : `
                                <button class="btn-delete" 
                                        onclick="alert('Default cards are protected. Unlock collection to delete.')"
                                        style="background: #ccc; cursor: not-allowed;">
                                    Delete
                                </button>
                            `}
                        </div>
                    </div>
                `;
                answerContainer.appendChild(cardDiv);
            });
            
            // Display question cards
            gameState.cardCollection.questions.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `card ${card.enabled ? '' : 'disabled'}`;
                if (card.isProtected) {
                    cardDiv.style.borderLeft = '4px solid #ff6b6b';
                    cardDiv.style.background = 'linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%)';
                }
                
                cardDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${card.text}</span>
                        <div class="collection-controls">
                            ${card.isDefault ? `
                                <span style="color: #666; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <span>Default</span>
                                    ${card.isProtected ? 'üîí' : ''}
                                </span>
                            ` : ''}
                            <button class="${card.enabled ? 'btn-disable' : 'btn-enable'}" 
                                    onclick="toggleCardEnabled('question', ${index})">
                                ${card.enabled ? 'Disable' : 'Enable'}
                            </button>
                            ${!card.isDefault || gameState.cardCollection.protectedUnlocked ? `
                                <button class="btn-delete" 
                                        onclick="deleteCard('question', ${index})">
                                    Delete
                                </button>
                            ` : `
                                <button class="btn-delete" 
                                        onclick="alert('Default cards are protected. Unlock collection to delete.')"
                                        style="background: #ccc; cursor: not-allowed;">
                                    Delete
                                </button>
                            `}
                        </div>
                    </div>
                `;
                questionContainer.appendChild(cardDiv);
            });
        }
        
        function toggleCardEnabled(type, index) {
            const collection = gameState.cardCollection[type + 's'];
            
            if (index >= 0 && index < collection.length) {
                const card = collection[index];
                
                // Check if it's a protected default card
                if (card.isProtected && card.isDefault && !gameState.cardCollection.protectedUnlocked) {
                    alert("Default cards are protected. Unlock collection to modify them.");
                    return;
                }
                
                collection[index].enabled = !collection[index].enabled;
                saveCardCollection();
                refreshCollection();
                updateDeckInfo();
            }
        }
        
        function deleteCard(type, index) {
            const collection = gameState.cardCollection[type + 's'];
            
            if (index >= 0 && index < collection.length) {
                const card = collection[index];
                
                // Check if it's a protected default card
                if (card.isProtected && card.isDefault && !gameState.cardCollection.protectedUnlocked) {
                    alert("Default cards are protected. Unlock collection to delete them.");
                    return;
                }
                
                if (!confirm("Are you sure you want to delete this card?")) {
                    return;
                }
                
                collection.splice(index, 1);
                saveCardCollection();
                refreshCollection();
                updateDeckInfo();
            }
        }
        
        function updateDeckInfo() {
            const enabledAnswers = gameState.cardCollection.answers.filter(card => card.enabled).length;
            const enabledQuestions = gameState.cardCollection.questions.filter(card => card.enabled).length;
            
            document.getElementById('answerCardsCount').textContent = enabledAnswers;
            document.getElementById('questionCardsCount').textContent = enabledQuestions;
            document.getElementById('deckRemaining').textContent = enabledAnswers + enabledQuestions;
        }
        
        // ==================== GAME UI UPDATES ====================
        function updateGameUI() {
            document.getElementById('usernameBadge').textContent = gameState.playerName + (gameState.isHost ? " (Host)" : "");
            document.getElementById('scoreBadge').textContent = `Score: ${gameState.scores[gameState.playerId] || 0}`;
            document.getElementById('roundBadge').textContent = `Round: ${gameState.currentRound}`;
            document.getElementById('playersBadge').textContent = `Players: ${gameState.players.length}`;
            
            if (gameState.gameCode) {
                document.getElementById('lobbyGameCode').textContent = gameState.gameCode;
                document.getElementById('quickGameCodeDisplay').textContent = gameState.gameCode;
            }
            document.getElementById('playerCount').textContent = gameState.players.length;
            document.getElementById('currentRound').textContent = gameState.currentRound;
            
            updateDeckInfo();
            updateLobbyPlayers();
            
            document.getElementById('roundNumber').textContent = gameState.currentRound;
            document.getElementById('playerScore').textContent = gameState.scores[gameState.playerId] || 0;
            
            // Update judge indicator
            const judgeIndicator = document.getElementById('judgeIndicator');
            if (judgeIndicator) {
                const judge = gameState.players[gameState.currentJudgeIndex];
                if (judge) {
                    document.getElementById('currentJudgeName').textContent = judge.name;
                    if (gameState.isJudge) {
                        judgeIndicator.style.display = 'inline-block';
                    } else {
                        judgeIndicator.style.display = 'none';
                    }
                }
            }
            
            // Show/hide host controls
            const hostControls = document.getElementById('hostControls');
            const playerControls = document.getElementById('playerControls');
            if (hostControls && playerControls) {
                if (gameState.isHost) {
                    hostControls.style.display = 'block';
                    playerControls.style.display = 'none';
                } else {
                    hostControls.style.display = 'none';
                    playerControls.style.display = 'block';
                }
            }
        }
        
        function updateLobbyPlayers() {
            const container = document.getElementById('lobbyPlayers');
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const isJudge = index === gameState.currentJudgeIndex;
                
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-card ${player.isHost ? 'host' : ''} ${isJudge ? 'judge' : ''}`;
                playerDiv.innerHTML = `
                    <div style="font-weight: bold; font-size: 16px;">${player.name}</div>
                    <div class="score-display">Score: ${gameState.scores[player.id] || 0}</div>
                    ${player.isHost ? '<div style="color: #FFD700; font-size: 12px; margin-top: 3px;">üëë Host</div>' : ''}
                    ${isJudge ? '<div style="color: #4CAF50; font-size: 12px; margin-top: 3px;">‚öñÔ∏è Judge</div>' : ''}
                `;
                container.appendChild(playerDiv);
            });
        }
        
        // ==================== BASIC GAME FUNCTIONS ====================
        function startGame() {
            if (!gameState.isHost) {
                alert("Only host can start the game");
                return;
            }
            
            if (gameState.players.length < 2) {
                alert("Need at least 2 players to start the game!");
                return;
            }
            
            // Reset game state
            gameState.currentRound = 1;
            gameState.gamePhase = "playing";
            gameState.submittedCards = [];
            gameState.createdCards = [];
            gameState.selectedCards = [];
            gameState.gameWinner = null;
            gameState.roundStarted = true;
            
            // Set first judge (random)
            gameState.currentJudgeIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.isJudge = (gameState.players[gameState.currentJudgeIndex].id === gameState.playerId);
            
            // Reset scores
            gameState.players.forEach(player => {
                gameState.scores[player.id] = 0;
            });
            
            initializeDecks();
            
            addSystemChatMessage(`Game started! ${gameState.players[gameState.currentJudgeIndex].name} is the first judge.`);
            
            dealHand();
            startRound();
            
            showScreen('game');
        }
        
        function dealHand() {
            gameState.hand = [];
            for (let i = 0; i < 6; i++) {
                const card = drawAnswerCard();
                gameState.hand.push(card);
            }
            gameState.selectedCards = [];
            updatePlayerHand();
        }
        
        function drawAnswerCard() {
            if (gameState.deck.length === 0) {
                console.log("Answer deck empty, reshuffling...");
                reshuffleDecks();
            }
            
            const card = gameState.deck.shift();
            gameState.usedAnswers.push(card);
            
            return card;
        }
        
        function reshuffleDecks() {
            const enabledAnswers = gameState.cardCollection.answers
                .filter(card => card.enabled)
                .map(card => card.text);
            
            const enabledQuestions = gameState.cardCollection.questions
                .filter(card => card.enabled)
                .map(card => card.text);
            
            gameState.deck = shuffleArrayProperly([...enabledAnswers]);
            gameState.questionDeck = shuffleArrayProperly([...enabledQuestions]);
            
            gameState.usedAnswers = [];
            gameState.usedQuestions = [];
            gameState.activeQuestion = null;
            
            console.log("Decks reshuffled:", {
                answers: gameState.deck.length,
                questions: gameState.questionDeck.length
            });
            
            addSystemChatMessage("Decks reshuffled!");
        }
        
        function updatePlayerHand() {
            const handContainer = document.getElementById('playerHand');
            handContainer.innerHTML = '';
            
            gameState.hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                
                const isSelected = gameState.selectedCards.includes(index);
                if (isSelected) {
                    cardDiv.classList.add('selected');
                }
                
                cardDiv.innerHTML = `
                    <div class="card-number">${index + 1}</div>
                    <div style="display: inline-block; font-size: 14px;">${card}</div>
                    ${isSelected ? `<span class="selection-counter">${gameState.selectedCards.indexOf(index) + 1}</span>` : ''}
                `;
                
                // Add both click and touch support
                cardDiv.onclick = () => selectCard(index);
                cardDiv.ontouchstart = (e) => {
                    e.preventDefault();
                    selectCard(index);
                };
                
                handContainer.appendChild(cardDiv);
            });
            
            document.getElementById('cardsInHand').textContent = gameState.hand.length;
            updateSubmitButton();
        }
        
        function selectCard(index) {
            if (index < 0 || index >= gameState.hand.length) return;
            if (gameState.isJudge) {
                alert("You are the judge! You cannot submit cards this round.");
                return;
            }
            
            const alreadySelectedIndex = gameState.selectedCards.indexOf(index);
            
            if (alreadySelectedIndex !== -1) {
                gameState.selectedCards.splice(alreadySelectedIndex, 1);
            } else {
                if (gameState.currentBlankCount > 1) {
                    if (gameState.selectedCards.length < gameState.currentBlankCount) {
                        gameState.selectedCards.push(index);
                    } else {
                        gameState.selectedCards.shift();
                        gameState.selectedCards.push(index);
                    }
                } else {
                    gameState.selectedCards = [index];
                }
            }
            
            updatePlayerHand();
            updateSelectedCardsDisplay();
            updateSubmitButton();
        }
        
        function updateSelectedCardsDisplay() {
            const selectedCardsList = document.getElementById('selectedCardsList');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCardsList.innerHTML = '';
            selectedCount.textContent = gameState.selectedCards.length;
            
            gameState.selectedCards.forEach((cardIndex, position) => {
                const card = gameState.hand[cardIndex];
                const cardDiv = document.createElement('div');
                cardDiv.className = 'selected-card-item';
                cardDiv.innerHTML = `
                    <span><strong>Blank ${position + 1}:</strong> ${card}</span>
                    <button class="remove-selection" onclick="removeSelection(${cardIndex})">√ó</button>
                `;
                selectedCardsList.appendChild(cardDiv);
            });
            
            document.getElementById('submitCount').textContent = gameState.selectedCards.length;
        }
        
        function removeSelection(cardIndex) {
            const index = gameState.selectedCards.indexOf(cardIndex);
            if (index !== -1) {
                gameState.selectedCards.splice(index, 1);
                updatePlayerHand();
                updateSelectedCardsDisplay();
                updateSubmitButton();
            }
        }
        
        function clearSelections() {
            gameState.selectedCards = [];
            updatePlayerHand();
            updateSelectedCardsDisplay();
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const required = gameState.currentBlankCount;
            const selected = gameState.selectedCards.length;
            
            // Judge cannot submit
            if (gameState.isJudge) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Judge (Cannot Submit)";
                return;
            }
            
            submitBtn.textContent = "Submit Card";
            if (required > 1) {
                submitBtn.disabled = selected !== required;
                if (selected === required) {
                    document.getElementById('statusText').textContent = `Ready to submit ${required} cards!`;
                } else {
                    document.getElementById('statusText').textContent = `Select ${required - selected} more card(s)`;
                }
            } else {
                submitBtn.disabled = selected === 0;
                if (selected > 0) {
                    document.getElementById('statusText').textContent = "Ready to submit card!";
                } else {
                    document.getElementById('statusText').textContent = "Select a card from your hand";
                }
            }
        }
        
        function startRound() {
            const question = getNextQuestion();
            gameState.currentBlankCount = (question.match(/_____/g) || []).length;
            gameState.selectedCards = [];
            
            document.getElementById('questionDisplay').textContent = question;
            updateMultiBlankUI();
            updateGameUI();
            updatePlayerPanel();
            
            // Start timer if enabled
            if (gameState.timeLimit > 0) {
                startTimer();
            }
            
            if (gameState.isJudge) {
                document.getElementById('statusText').textContent = "You are the judge. Waiting for players to submit cards...";
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = "Judge (Cannot Submit)";
            } else {
                document.getElementById('statusText').textContent = gameState.currentBlankCount > 1 
                    ? `Select ${gameState.currentBlankCount} cards for the blanks` 
                    : "Select a card from your hand";
            }
            
            addSystemChatMessage(`Round ${gameState.currentRound} started! Question: ${question}`);
            addSystemChatMessage(`${gameState.players[gameState.currentJudgeIndex].name} is the judge.`);
            
            document.addEventListener('keydown', handleNumberKey);
        }
        
        function getNextQuestion() {
            if (gameState.questionDeck.length === 0) {
                console.log("Question deck empty, reshuffling...");
                reshuffleDecks();
            }
            
            const question = gameState.questionDeck.shift();
            gameState.usedQuestions.push(question);
            gameState.activeQuestion = question;
            
            console.log("Selected question:", question);
            
            return question;
        }
        
        function updateMultiBlankUI() {
            const multiBlankInstructions = document.getElementById('multiBlankInstructions');
            const selectedCardsDisplay = document.getElementById('selectedCardsDisplay');
            const clearBtn = document.getElementById('clearBtn');
            const submitCount = document.getElementById('submitCount');
            
            if (gameState.currentBlankCount > 1) {
                multiBlankInstructions.style.display = 'block';
                selectedCardsDisplay.style.display = 'block';
                clearBtn.style.display = 'inline-flex';
                submitCount.style.display = 'inline-flex';
                
                document.getElementById('requiredCardsCount').textContent = gameState.currentBlankCount;
                document.getElementById('totalRequired').textContent = gameState.currentBlankCount;
                updateSelectedCardsDisplay();
            } else {
                multiBlankInstructions.style.display = 'none';
                selectedCardsDisplay.style.display = 'none';
                clearBtn.style.display = 'none';
                submitCount.style.display = 'none';
            }
            
            updateSubmitButton();
        }
        
        function handleNumberKey(event) {
            if (gameState.gamePhase !== "playing") return;
            
            const key = event.key;
            const number = parseInt(key);
            
            if (number >= 1 && number <= 6) {
                selectCard(number - 1);
            }
        }
        
        function submitCard() {
            if (gameState.isJudge) {
                alert("You are the judge! You cannot submit cards this round.");
                return;
            }
            
            if (gameState.selectedCards.length === 0) {
                alert("Select at least one card first");
                return;
            }
            
            let submittedCardText;
            if (gameState.currentBlankCount > 1) {
                submittedCardText = gameState.selectedCards
                    .map(index => gameState.hand[index])
                    .join(', ');
            } else {
                submittedCardText = gameState.hand[gameState.selectedCards[0]];
            }
            
            const selectedIndices = [...gameState.selectedCards].sort((a, b) => b - a);
            
            selectedIndices.forEach(index => {
                gameState.hand.splice(index, 1);
                
                if (gameState.hand.length < 6) {
                    const newCard = drawAnswerCard();
                    gameState.hand.push(newCard);
                }
            });
            
            gameState.submittedCards.push({
                player: gameState.playerName,
                playerId: gameState.playerId,
                card: submittedCardText,
                index: gameState.submittedCards.length
            });
            
            gameState.selectedCards = [];
            
            // Stop timer for this player
            stopTimer();
            
            document.getElementById('statusText').textContent = "Card submitted! Waiting for other players...";
            document.getElementById('submitBtn').disabled = true;
            
            updatePlayerHand();
            updateSelectedCardsDisplay();
            
            addSystemChatMessage(`${gameState.playerName} submitted a card.`);
            
            // In a real game, this would be sent to the server
            // For now, we'll simulate other players submitting
            if (gameState.isHost) {
                // Simulate other players submitting
                setTimeout(() => {
                    simulateOtherPlayers();
                }, 2000);
                
                // Auto-start judging after delay
                setTimeout(() => {
                    if (gameState.isHost) {
                        startJudging();
                    }
                }, 5000);
            }
        }
        
        function simulateOtherPlayers() {
            // Simulate other players submitting cards
            const otherPlayers = gameState.players.filter(p => p.id !== gameState.playerId);
            const simulatedCards = [
                "A simulated response",
                "Another player's card",
                "Creative answer here",
                "Something funny",
                "Wild card submission"
            ];
            
            otherPlayers.forEach((player, index) => {
                if (index < simulatedCards.length) {
                    setTimeout(() => {
                        gameState.submittedCards.push({
                            player: player.name,
                            playerId: player.id,
                            card: simulatedCards[index],
                            index: gameState.submittedCards.length
                        });
                        addSystemChatMessage(`${player.name} submitted a card.`);
                    }, index * 1000);
                }
            });
        }
        
        function startJudging() {
            gameState.gamePhase = "judging";
            stopTimer();
            
            const question = document.getElementById('questionDisplay').textContent;
            document.getElementById('judgeQuestion').textContent = question;
            
            const blankCount = (question.match(/_____/g) || []).length;
            const optionsContainer = document.getElementById('judgeOptions');
            optionsContainer.innerHTML = '';
            
            // Only show judging screen to the judge
            if (gameState.isJudge) {
                gameState.submittedCards.forEach((submission, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'judge-option';
                    
                    if (blankCount > 1) {
                        const answerParts = submission.card.split(',').map(part => part.trim());
                        optionDiv.innerHTML = `
                            <div style="font-size: 20px; color: #667eea; margin-bottom: 8px;">Option ${index + 1}</div>
                            <div class="multi-blank-answer">
                                ${answerParts.map((part, i) => `
                                    <div class="blank-answer-part">
                                        <span class="blank-number">Blank ${i + 1}:</span> ${part}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="color: #666; font-size: 13px; margin-top: 8px;">From: ${submission.player}</div>
                        `;
                    } else {
                        optionDiv.innerHTML = `
                            <div style="font-size: 20px; color: #667eea; margin-bottom: 8px;">Option ${index + 1}</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">${submission.card}</div>
                            <div style="color: #666; font-size: 13px;">From: ${submission.player}</div>
                        `;
                    }
                    
                    // Add both click and touch support
                    optionDiv.onclick = () => selectWinner(index);
                    optionDiv.ontouchstart = (e) => {
                        e.preventDefault();
                        selectWinner(index);
                    };
                    
                    optionsContainer.appendChild(optionDiv);
                });
                
                showScreen('judging');
                addSystemChatMessage(`Judging started! ${gameState.playerName} is selecting the winner.`);
            } else {
                // Non-judges see waiting screen
                showScreen('game');
                document.getElementById('statusText').textContent = "Waiting for judge to select winner...";
            }
        }
        
        function selectWinner(index) {
            if (!gameState.isJudge) {
                alert("Only the judge can select the winner!");
                return;
            }
            
            const winner = gameState.submittedCards[index];
            
            if (gameState.scores[winner.playerId] !== undefined) {
                gameState.scores[winner.playerId]++;
            }
            
            // Rotate judge for next round
            gameState.currentJudgeIndex = (gameState.currentJudgeIndex + 1) % gameState.players.length;
            gameState.isJudge = (gameState.players[gameState.currentJudgeIndex].id === gameState.playerId);
            
            gameState.gameWinner = checkForGameWinner();
            gameState.submittedCards = [];
            
            addSystemChatMessage(`${winner.player} won round ${gameState.currentRound}! Next judge: ${gameState.players[gameState.currentJudgeIndex].name}`);
            
            if (gameState.gameWinner) {
                const winnerPlayer = gameState.players.find(p => p.id === gameState.gameWinner);
                showGameWinner(winnerPlayer);
            } else {
                showRoundWinner(winner);
            }
        }
        
        function checkForGameWinner() {
            for (const [playerId, score] of Object.entries(gameState.scores)) {
                if (score >= gameState.winningScore) {
                    return playerId;
                }
            }
            return null;
        }
        
        function showRoundWinner(winner) {
            document.getElementById('winnerDetails').innerHTML = `
                <div style="font-size: 20px; margin: 10px 0;">${winner.card}</div>
                <div style="color: #666;">By: ${winner.player}</div>
                <div style="margin-top: 10px; color: #4CAF50; font-weight: bold;">üéâ Round Winner! üéâ</div>
            `;
            
            document.getElementById('winnerScore').textContent = gameState.scores[winner.playerId];
            document.getElementById('roundsPlayed').textContent = gameState.currentRound;
            document.getElementById('deckSize').textContent = gameState.deck.length;
            
            // Show review button if cards were created
            const reviewBtn = document.getElementById('reviewBtn');
            if (gameState.createdCards.length > 0) {
                reviewBtn.style.display = 'inline-flex';
                reviewBtn.textContent = `Review Created Cards (${gameState.createdCards.length})`;
            } else {
                reviewBtn.style.display = 'none';
            }
            
            document.getElementById('gameWinnerAnnouncement').style.display = 'none';
            document.getElementById('nextRoundBtn').style.display = 'inline-flex';
            
            showScreen('winner');
        }
        
        function showGameWinner(winnerPlayer) {
            document.getElementById('gameWinnerDetails').innerHTML = `
                <div style="font-size: 24px; margin: 10px 0;">${winnerPlayer.name} Wins!</div>
                <div style="font-size: 18px; color: #666;">Score: ${gameState.scores[winnerPlayer.id]} points</div>
                <div style="margin-top: 10px; font-size: 16px; color: #FFD700;">üèÜ GAME CHAMPION! üèÜ</div>
            `;
            
            document.getElementById('gameWinnerAnnouncement').style.display = 'block';
            document.getElementById('winnerScore').textContent = gameState.scores[winnerPlayer.id];
            document.getElementById('roundsPlayed').textContent = gameState.currentRound;
            document.getElementById('deckSize').textContent = gameState.deck.length;
            
            document.getElementById('nextRoundBtn').style.display = 'none';
            
            // Show review button if cards were created
            const reviewBtn = document.getElementById('reviewBtn');
            if (gameState.createdCards.length > 0) {
                reviewBtn.style.display = 'inline-flex';
                reviewBtn.textContent = `Review Created Cards (${gameState.createdCards.length})`;
            } else {
                reviewBtn.style.display = 'none';
            }
            
            showScreen('winner');
        }
        
        function continueToNextRound() {
            gameState.currentRound++;
            gameState.submittedCards = [];
            gameState.selectedCards = [];
            
            if (gameState.currentRound > gameState.maxRounds) {
                let highestScore = 0;
                let winnerId = null;
                
                for (const [playerId, score] of Object.entries(gameState.scores)) {
                    if (score > highestScore) {
                        highestScore = score;
                        winnerId = playerId;
                    }
                }
                
                if (winnerId) {
                    const winnerPlayer = gameState.players.find(p => p.id === winnerId);
                    showGameWinner(winnerPlayer);
                    return;
                }
            }
            
            dealHand();
            startRound();
            
            showScreen('game');
        }
        
        function endGamePrematurely() {
            if (!gameState.isHost) {
                alert("Only host can end the game");
                return;
            }
            
            if (confirm("Are you sure you want to end the game early?")) {
                if (gameState.createdCards.length > 0) {
                    showReviewScreen();
                } else {
                    showScreen('menu');
                }
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function copyGameLink() {
            const baseUrl = window.location.origin + window.location.pathname;
            const link = `${baseUrl}?join=${gameState.gameCode}`;
            navigator.clipboard.writeText(link)
                .then(() => alert("Game link copied to clipboard!\n\n" + link))
                .catch(() => alert("Failed to copy link"));
        }
        
        function leaveGame() {
            if (confirm("Are you sure you want to leave the game?")) {
                stopTimer();
                
                gameState = {
                    playerName: gameState.playerName,
                    gameCode: null,
                    isHost: false,
                    players: [],
                    currentRound: 1,
                    hand: [],
                    selectedCards: [],
                    gamePhase: "menu",
                    scores: {},
                    createdCards: [],
                    cardCollection: gameState.cardCollection,
                    deck: [],
                    questionDeck: [],
                    allAnswers: [],
                    allQuestions: [],
                    usedQuestions: [],
                    usedAnswers: [],
                    currentBlankCount: 1,
                    activeQuestion: null,
                    gameWinner: null,
                    timeLimit: 45,
                    timerRunning: false,
                    timeLeft: 45,
                    currentJudgeIndex: 0,
                    roundStarted: false,
                    playerId: null,
                    chatMessages: []
                };
                showScreen('menu');
            }
        }
        
        function returnToLobby() {
            stopTimer();
            showScreen('lobby');
        }
        
        // ==================== DEV TOOLS ====================
        function showDevTools() {
            const modalContent = `
                <h2>üõ†Ô∏è Development Tools</h2>
                <div class="form-group">
                    <label>Quick Test Options:</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="simulateMultiplayerTest()">
                            Simulate 3 Players
                        </button>
                        <button class="btn btn-secondary" onclick="forceDeckReshuffle()">
                            Force Deck Reshuffle
                        </button>
                        <button class="btn btn-secondary" onclick="addTestCards()">
                            Add 10 Test Cards
                        </button>
                        <button class="btn btn-warning" onclick="dumpGameState()">
                            Dump Game State to Console
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Game Code:</label>
                    <div class="game-code" id="devGameCode">${gameState.gameCode || 'No active game'}</div>
                    <button class="btn" onclick="copyDevGameCode()" style="margin-top: 10px;">
                        Copy Game Code
                    </button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="hideModal('devToolsModal')">
                        Close
                    </button>
                </div>
            `;
            
            showCustomModal('Dev Tools', modalContent, 'devToolsModal');
        }
        
        function simulateMultiplayerTest() {
            if (!gameState.gameCode) {
                alert("Create a game first!");
                return;
            }
            
            const testPlayers = ['Test Alice', 'Test Bob', 'Test Charlie'];
            testPlayers.forEach(playerName => {
                const playerId = 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                gameState.players.push({
                    name: playerName,
                    isHost: false,
                    score: Math.floor(Math.random() * 5),
                    id: playerId,
                    isConnected: true
                });
                gameState.scores[playerId] = gameState.players[gameState.players.length - 1].score;
                
                // Add chat message
                addSystemChatMessage(`${playerName} joined the game!`);
            });
            
            updateGameUI();
            updatePlayerPanel();
            hideModal('devToolsModal');
            alert(`Added ${testPlayers.length} test players!`);
        }
        
        function forceDeckReshuffle() {
            reshuffleDecks();
            alert(`Decks reshuffled!\nAnswers: ${gameState.deck.length}\nQuestions: ${gameState.questionDeck.length}`);
        }
        
        function addTestCards() {
            const testAnswers = [
                "Debugging this game.",
                "A test card for multiplayer.",
                "Another test answer.",
                "This is only a test.",
                "If this were real, you'd be laughing.",
                "Test card #6",
                "Seventh test card",
                "Eighth test entry",
                "Ninth test response",
                "Final test card"
            ];
            
            const testQuestions = [
                "Why is the developer testing? _____",
                "What broke this time? _____",
                "Test question with _____ blank"
            ];
            
            testAnswers.forEach(answer => {
                gameState.cardCollection.answers.push({
                    text: answer,
                    enabled: true,
                    isDefault: false,
                    isProtected: false
                });
            });
            
            testQuestions.forEach(question => {
                gameState.cardCollection.questions.push({
                    text: question,
                    enabled: true,
                    isDefault: false,
                    isProtected: false
                });
            });
            
            saveCardCollection();
            alert(`Added ${testAnswers.length} answer cards and ${testQuestions.length} question cards!`);
        }
        
        function dumpGameState() {
            console.log("=== GAME STATE DUMP ===");
            console.log("Players:", gameState.players);
            console.log("Scores:", gameState.scores);
            console.log("Deck size:", gameState.deck.length);
            console.log("Question deck size:", gameState.questionDeck.length);
            console.log("Current round:", gameState.currentRound);
            console.log("Game phase:", gameState.gamePhase);
            console.log("Current judge:", gameState.players[gameState.currentJudgeIndex]?.name);
            console.log("Time limit:", gameState.timeLimit);
            console.log("Full state:", JSON.parse(JSON.stringify(gameState)));
            hideModal('devToolsModal');
            alert("Game state dumped to console! (Press F12 to view)");
        }
        
        function copyDevGameCode() {
            if (gameState.gameCode) {
                navigator.clipboard.writeText(gameState.gameCode)
                    .then(() => alert("Game code copied!"))
                    .catch(() => alert("Failed to copy"));
            }
        }
        
        function showRemoteHelp() {
            const helpText = `
                <h3>üìû Remote Testing Help</h3>
                <p><strong>Game Code:</strong> ${gameState.gameCode || 'None'}</p>
                <p><strong>Your Name:</strong> ${gameState.playerName}</p>
                <p><strong>Players in Game:</strong> ${gameState.players.length}</p>
                <p><strong>Status:</strong> ${gameState.gamePhase}</p>
                <p><strong>Share this info with your testing partner if you're stuck!</strong></p>
                <div class="action-buttons">
                    <button class="btn" onclick="location.reload()">
                        üîÑ Refresh Page
                    </button>
                    <button class="btn btn-secondary" onclick="hideModal('helpModal')">
                        Close
                    </button>
                </div>
            `;
            showCustomModal('Remote Help', helpText, 'helpModal');
        }
        
        // ==================== INITIALIZATION ====================
        window.onload = function() {
            console.log("Game loaded");
            
            initializeCardCollection();
            
            // Check URL for game code
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            if (joinCode) {
                document.getElementById('gameCodeInput').value = joinCode;
                document.getElementById('gameCodeInput').style.borderColor = '#4CAF50';
                document.getElementById('playerName').focus();
            }
            
            // Set up event listeners
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    quickCreateGame();
                }
            });
            
            document.getElementById('gameCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    quickJoinGame();
                }
            });
            
            // Initialize timer slider
            updateTimeLimit();
            
            // Add floating help buttons
            const devBtn = document.createElement('button');
            devBtn.className = 'dev-tools-btn';
            devBtn.innerHTML = 'üõ†Ô∏è';
            devBtn.title = 'Development Tools';
            devBtn.onclick = showDevTools;
            document.body.appendChild(devBtn);
            
            const helpBtn = document.createElement('button');
            helpBtn.className = 'remote-help-btn';
            helpBtn.innerHTML = '‚ùì';
            helpBtn.title = 'Remote Help';
            helpBtn.onclick = showRemoteHelp;
            document.body.appendChild(helpBtn);
            
            // Check if user is logged in
            const lastUser = localStorage.getItem('lastUser');
            if (lastUser) {
                const users = JSON.parse(localStorage.getItem('cardGameUsers') || '{}');
                if (users[lastUser]) {
                    gameState.currentUser = lastUser;
                    gameState.cardCollection = users[lastUser].collection;
                    document.getElementById('usernameBadge').textContent = lastUser;
                }
            }
        };
    </script>
</body>
  </html>
