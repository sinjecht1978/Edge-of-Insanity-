
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cards Game - Multiplayer with Accounts</title>
    <style>
        /* ========== ALL YOUR ORIGINAL CSS ========== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }
        
        .screen.active {
            display: flex;
        }
        
        .header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            text-align: center;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
            color: #333;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
        }
        
        .card.selected {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .card.disabled {
            opacity: 0.5;
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .card.disabled:hover {
            transform: none;
            border-color: #e0e0e0;
        }
        
        .card.black {
            background: #333;
            color: white;
            border-color: #222;
            padding: 12px;
            font-size: 16px;
            text-align: center;
            margin: 8px 0;
            cursor: default;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .hand-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 8px;
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 150px;
        }
        
        @media (max-width: 768px) {
            .hand-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
            justify-content: center;
        }
        
        .player-card {
            background: #f5f5f5;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            min-width: 80px;
            position: relative;
            font-size: 11px;
        }
        
        .player-card.host::after {
            content: "üëë";
            position: absolute;
            top: -4px;
            right: -4px;
            background: gold;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }
        
        .player-card.judge::after {
            content: "‚öñÔ∏è";
            position: absolute;
            top: -4px;
            left: -4px;
            background: #4CAF50;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 9px;
        }
        
        .timer-container {
            text-align: center;
            margin: 6px 0;
            padding: 6px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        
        .timer {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .timer.warning {
            color: #ff9800;
        }
        
        .timer.danger {
            color: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .points-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
        }
        
        .point-item {
            text-align: center;
            min-width: 60px;
        }
        
        .point-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .point-label {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
            justify-content: center;
        }
        
        .winner-announcement {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 8px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        
        .judge-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 10px 0;
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }
        
        @media (min-width: 768px) {
            .judge-options {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        .judge-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .judge-option:hover {
            transform: translateY(-3px);
            border-color: #667eea;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 11px;
            max-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #4CAF50;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 10px 0;
        }
        
        .tab-button {
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            position: relative;
            flex: 1;
            text-align: center;
        }
        
        .tab-button.active {
            color: #667eea;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        .collection-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .collection-controls {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 4px;
        }
        
        .collection-controls button {
            padding: 3px 6px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
        }
        
        .deck-info {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 6px;
            margin: 6px 0;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .game-status {
            margin: 6px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }
        
        .selected-count {
            background: #4CAF50;
            color: white;
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
        }
        
        .multi-answer-container {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 6px;
            margin: 6px 0;
        }
        
        .answer-item {
            background: white;
            border-left: 3px solid #667eea;
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
        }
        
        .answer-number {
            background: #667eea;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            margin-right: 8px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 11px;
        }
        
        .all-submissions-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .submission-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            margin: 6px 0;
        }
        
        .share-section {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .share-url {
            background: white;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 6px;
            margin: 6px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 10px;
        }
        
        .compact-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin: 8px 0;
        }
        
        .compact-label {
            font-size: 12px;
            color: #666;
            min-width: 100px;
        }
        
        .compact-input {
            flex: 1;
            min-width: 180px;
            padding: 6px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .compact-textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            min-height: 70px;
            max-height: 120px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }
        
        .stat-box {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .small-btn {
            padding: 4px 8px;
            font-size: 11px;
            margin: 2px;
        }
        
        .content-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }
        
        .game-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .game-content {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }
        
        .menu-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .invite-link-container {
            margin-top: 15px;
            padding: 12px;
            background: #f0f8ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
        }
        
        /* ========== NEW CSS FOR MULTIPLAYER ========== */
        .auth-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .auth-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .auth-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-players {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .player-online {
            background: white;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 6px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .status-online {
            background: #4CAF50;
        }
        
        .status-ingame {
            background: #FF9800;
        }
        
        .status-offline {
            background: #f44336;
        }
        
        .room-list {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .room-item {
            background: white;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 10px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-item:hover {
            background: #e6f0ff;
            transform: translateY(-2px);
        }
        
        .room-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .chat-container {
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            height: 300px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 6px;
            background: #f5f5f5;
            font-size: 13px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .friends-list {
            background: #fff8e1;
            border: 2px solid #FFB300;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .friend-item {
            background: white;
            border: 1px solid #FFB300;
            border-radius: 6px;
            padding: 8px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>

    <!-- Add these AFTER your <style> block -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#764ba2">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style"content="black-translucent">
    
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</head>
<body>
    <div class="container">
        <!-- Screen 0: Login/Register -->
        <div id="authScreen" class="screen active">
            <div class="header">
                <h1 style="font-size: 26px;">üé¥ Cards Game</h1>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">Create account or login to play</p>
            </div>
            
            <div class="menu-content">
                <!-- Login Form -->
                <div class="auth-section">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Login to Your Account</h3>
                    <div class="auth-form">
                        <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                        <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                        <div class="auth-buttons">
                            <button class="btn btn-success" onclick="login()" style="flex: 1;">
                                Login
                            </button>
                            <button class="btn btn-secondary" onclick="quickLogin()" style="flex: 1;">
                                Quick Play (Guest)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Register Form -->
                <div class="auth-section">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Create New Account</h3>
                    <div class="auth-form">
                        <input type="text" id="registerUsername" class="auth-input" placeholder="Choose username" required>
                        <input type="email" id="registerEmail" class="auth-input" placeholder="Email (optional)">
                        <input type="password" id="registerPassword" class="auth-input" placeholder="Choose password" required>
                        <input type="password" id="registerConfirmPassword" class="auth-input" placeholder="Confirm password" required>
                        <button class="btn btn-success" onclick="register()" style="width: 100%;">
                            Create Account
                        </button>
                    </div>
                </div>
                
                <!-- Quick Info -->
                <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <h3 style="color: #666; margin-bottom: 10px; font-size: 16px;">üéÆ Features:</h3>
                    <ul style="color: #666; font-size: 13px; line-height: 1.6; padding-left: 20px;">
                        <li><strong>Free Account:</strong> Save your card collection</li>
                        <li><strong>Play with Friends:</strong> Create private rooms</li>
                        <li><strong>Public Matchmaking:</strong> Join random games</li>
                        <li><strong>Play with Bots:</strong> Solo practice mode</li>
                        <li><strong>Create Cards:</strong> Add custom cards to your collection</li>
                        <li><strong>Friends System:</strong> Add and chat with friends</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Screen 1: Main Menu -->
        <div id="menuScreen" class="screen">
            <div class="header">
                <div class="user-info">
                    <div>
                        <span style="font-weight: bold; font-size: 16px;">üë§ <span id="currentUsername">Guest</span></span>
                        <span style="font-size: 12px; opacity: 0.9;" id="userStatus">Online</span>
                    </div>
                    <button class="btn btn-warning" onclick="logout()" style="padding: 6px 12px; font-size: 12px;">
                        Logout
                    </button>
                </div>
                
                <h1 style="font-size: 22px; margin-top: 10px;">üé¥ Cards Game</h1>
                <p style="color: #666; font-size: 13px;">Play with bots, friends, or random players!</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchMenuTab('play')">Play</button>
                <button class="tab-button" onclick="switchMenuTab('social')">Social</button>
                <button class="tab-button" onclick="switchMenuTab('cards')">Cards</button>
            </div>
            
            <!-- Play Tab -->
            <div id="playTab" class="tab-content active">
                <div class="menu-content">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="startSolitaireGame()" style="width: 100%; margin-bottom: 8px;">
                            üöÄ Play vs Bots (3 Bots)
                        </button>
                        <button class="btn btn-secondary" onclick="showScreen('createRoom')" style="width: 100%; margin-bottom: 8px;">
                            üè† Create Private Room
                        </button>
                        <button class="btn btn-warning" onclick="showScreen('publicRooms')" style="width: 100%; margin-bottom: 8px;">
                            üåê Public Matchmaking
                        </button>
                    </div>
                    
                    <!-- Quick Join Section -->
                    <div class="share-section">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">üîó Quick Join</h3>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="roomCodeInput" class="compact-input" placeholder="Enter room code">
                            <button class="btn btn-success" onclick="joinRoomByCode()" style="min-width: 80px;">
                                Join
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Game Invites -->
                    <div id="activeInvitesContainer" class="invite-link-container" style="display: none;">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">üéÆ Active Invites</h3>
                        <div id="activeInvitesList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Social Tab -->
            <div id="socialTab" class="tab-content">
                <div class="content-scrollable">
                    <!-- Friends List -->
                    <div class="friends-list">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">üë• Friends</h3>
                        <div id="friendsList">
                            <p style="text-align: center; color: #666; font-size: 13px;">No friends yet</p>
                        </div>
                        <div style="margin-top: 10px;">
                            <input type="text" id="addFriendInput" class="compact-input" placeholder="Friend's username" style="margin-bottom: 8px;">
                            <button class="btn btn-secondary" onclick="sendFriendRequest()" style="width: 100%;">
                                Add Friend
                            </button>
                        </div>
                    </div>
                    
                    <!-- Online Players -->
                    <div class="online-players">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">üåê Online Players</h3>
                        <div id="onlinePlayersList">
                            <p style="text-align: center; color: #666; font-size: 13px;">Loading...</p>
                        </div>
                    </div>
                    
                    <!-- Chat -->
                    <div class="chat-container">
                        <div class="chat-messages" id="globalChatMessages">
                            <p style="text-align: center; color: #666; font-size: 13px;">Global chat loading...</p>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="globalChatInput" class="chat-input" placeholder="Type a message...">
                            <button class="btn" onclick="sendGlobalChat()" style="margin-left: 8px;">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cards Tab -->
            <div id="cardsTab" class="tab-content">
                <div class="content-scrollable">
                    <!-- Card Stats -->
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="menuAnswerCount">0</div>
                            <div class="stat-label">Answer Cards</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="menuQuestionCount">0</div>
                            <div class="stat-label">Question Cards</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="menuCustomCount">0</div>
                            <div class="stat-label">Custom Cards</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">7</div>
                            <div class="stat-label">Points to Win</div>
                        </div>
                    </div>
                    
                    <!-- Card Management -->
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="showScreen('collection')">
                            üÉè Manage Cards
                        </button>
                        <button class="btn btn-warning" onclick="showScreen('create')">
                            ‚ú® Create Cards
                        </button>
                        <button class="btn btn-secondary" onclick="showScreen('share')">
                            üîó Share Cards
                        </button>
                    </div>
                    
                    <!-- Collection Preview -->
                    <div style="background: #f9f9f9; border-radius: 8px; padding: 10px; margin-top: 10px;">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">Your Collection</h3>
                        <div id="collectionPreview">
                            <p style="color: #666; font-size: 13px;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen 2: Create Room -->
        <div id="createRoomScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">üè† Create Private Room</h2>
                <p style="color: #666; font-size: 13px;">Invite friends with room code</p>
            </div>
            
            <div class="menu-content">
                <!-- Room Settings -->
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">Room Settings</h3>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">Room Name:</label>
                        <input type="text" id="roomName" class="compact-input" placeholder="My Awesome Game" value="My Game Room">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">Max Players:</label>
                        <select id="roomMaxPlayers" class="compact-input" style="padding: 8px;">
                            <option value="4">4 Players</option>
                            <option value="5">5 Players</option>
                            <option value="6" selected>6 Players</option>
                            <option value="7">7 Players</option>
                            <option value="8">8 Players</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">Points to Win:</label>
                        <select id="roomPointsToWin" class="compact-input" style="padding: 8px;">
                            <option value="5">5 Points</option>
                            <option value="7" selected>7 Points</option>
                            <option value="10">10 Points</option>
                            <option value="15">15 Points</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">
                            <input type="checkbox" id="roomEnableTimer" checked> Enable Timer
                        </label>
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">
                            <input type="checkbox" id="roomAllowCardCreation" checked> Allow Card Creation
                        </label>
                        <label style="font-size: 14px; display: block; margin-bottom: 6px;">
                            <input type="checkbox" id="roomAddBots" checked> Add Bots to Fill Room
                        </label>
                    </div>
                </div>
                
                <!-- Create Room Button -->
                <button class="btn btn-success" onclick="createPrivateRoom()" style="width: 100%; padding: 12px; font-size: 16px;">
                    üöÄ Create Room & Generate Invite Code
                </button>
                
                <!-- Room Code Display -->
                <div id="roomCodeContainer" class="share-section" style="display: none; margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 8px;">Room Created!</h3>
                    <p style="font-size: 12px; margin-bottom: 8px;">Share this code with friends:</p>
                    <div class="share-url" id="roomCodeDisplay" style="font-size: 18px; font-weight: bold; text-align: center; padding: 15px;"></div>
                    <button class="btn btn-secondary" onclick="copyRoomCode()" style="margin: 8px 0; width: 100%;">
                        üìã Copy Room Code
                    </button>
                    
                    <!-- Invite Friends Directly -->
                    <div style="margin-top: 15px;">
                        <h4 style="font-size: 14px; margin-bottom: 8px;">Invite Friends:</h4>
                        <div id="friendInviteList"></div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn" onclick="showScreen('menu')">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 3: Public Rooms -->
        <div id="publicRoomsScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">üåê Public Matchmaking</h2>
                <p style="color: #666; font-size: 13px;">Join public games or create your own</p>
            </div>
            
            <div class="menu-content">
                <!-- Quick Match -->
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">‚ö° Quick Match</h3>
                    <p style="font-size: 13px; margin-bottom: 12px;">Find a game automatically:</p>
                    <button class="btn btn-success" onclick="findQuickMatch()" style="width: 100%; padding: 12px;">
                        üîç Find Quick Match
                    </button>
                    <div style="margin-top: 10px; text-align: center;">
                        <span id="quickMatchStatus" style="font-size: 12px; color: #666;">Ready to match...</span>
                    </div>
                </div>
                
                <!-- Room List -->
                <div class="room-list">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">üè† Available Public Rooms</h3>
                    <div id="publicRoomsList">
                        <p style="text-align: center; color: #666; font-size: 13px; padding: 20px;">
                            Loading public rooms...
                        </p>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshPublicRooms()" style="width: 100%; margin-top: 10px;">
                        üîÑ Refresh List
                    </button>
                </div>
                
                <!-- Create Public Room -->
                <div class="share-section" style="margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">üéÆ Create Public Room</h3>
                    <button class="btn btn-warning" onclick="createPublicRoom()" style="width: 100%; padding: 12px;">
                        üöÄ Create Public Room
                    </button>
                </div>
                
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn" onclick="showScreen('menu')">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen 4: Room Lobby -->
        <div id="roomLobbyScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">üéÆ Room Lobby</h2>
                <p style="color: #666; font-size: 13px;" id="lobbyRoomName">Loading...</p>
            </div>
            
            <div class="menu-content">
                <!-- Room Info -->
                <div class="share-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 16px;">Room: <span id="lobbyRoomCode">----</span></h3>
                        <div style="font-size: 12px; color: #666;">
                            <span id="lobbyPlayerCount">0</span>/<span id="lobbyMaxPlayers">6</span> Players
                        </div>
                    </div>
                    
                    <!-- Room Settings (Host Only) -->
                    <div id="hostControls" style="display: none; margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px;">
                        <h4 style="font-size: 14px; margin-bottom: 8px;">‚öôÔ∏è Host Controls</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="startGameFromLobby()">
                                üöÄ Start Game
                            </button>
                            <button class="btn btn-warning" onclick="kickAllBots()">
                                ü§ñ Remove Bots
                            </button>
                            <button class="btn" onclick="addBotToRoom()">
                                ‚ûï Add Bot
                            </button>
                            <button class="btn btn-danger" onclick="closeRoom()">
                                ‚ùå Close Room
                            </button>
                        </div>
                    </div>
                    
                    <!-- Invite Section -->
                    <div style="margin-top: 10px;">
                        <div class="share-url" id="lobbyInviteCode" style="text-align: center; font-weight: bold; font-size: 16px; padding: 10px;"></div>
                        <button class="btn btn-secondary" onclick="copyLobbyInvite()" style="width: 100%; margin-top: 8px;">
                            üìã Copy Invite Code
                        </button>
                    </div>
                </div>
                
                <!-- Players List -->
                <div class="online-players" style="flex: 1; margin: 10px 0;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">üë• Players in Room</h3>
                    <div id="lobbyPlayersList">
                        <p style="text-align: center; color: #666; font-size: 13px;">Loading players...</p>
                    </div>
                </div>
                
                <!-- Chat -->
                <div class="chat-container" style="height: 200px;">
                    <div class="chat-messages" id="roomChatMessages">
                        <p style="text-align: center; color: #666; font-size: 13px;">Room chat</p>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="roomChatInput" class="chat-input" placeholder="Type to room chat...">
                        <button class="btn" onclick="sendRoomChat()" style="margin-left: 8px;">
                            Send
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="readyToggle()" id="readyButton">
                        ‚úÖ Ready
                    </button>
                    <button class="btn btn-warning" onclick="leaveRoom()">
                        Leave Room
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ========== YOUR ORIGINAL SCREENS (UNCHANGED) ========== -->
        
        <!-- Screen 5: Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="game-main-area">
                <div class="header">
                    <h2 style="font-size: 18px;">Round <span id="roundNumber">1</span></h2>
                    <div class="timer-container">
                        <div id="timerDisplay" class="timer">45:00</div>
                        <div style="color: #666; font-size: 10px;">Time remaining</div>
                    </div>
                </div>
                
                <!-- Sticky Question Display -->
                <div class="card black" id="questionDisplay">
                    Loading question...
                </div>
                
                <div class="game-content">
                    <div class="game-status">
                        <strong>Status:</strong> <span id="statusText">Select a card from your hand</span>
                        <span id="selectedCountInfo" class="selected-count"></span>
                    </div>
                    
                    <div style="margin: 6px 0; padding: 4px 10px; background: #4CAF50; color: white; border-radius: 12px; display: inline-block; font-size: 11px; text-align: center; width: 100%;">
                        ‚öñÔ∏è Judge: <span id="currentJudgeName">Loading...</span>
                    </div>
                    
                    <!-- Deck Info -->
                    <div class="deck-info">
                        <div>
                            <strong>Answers:</strong> 
                            <span id="answerDeckCount">0</span> left
                            (<span id="answerDiscardCount">0</span> used)
                        </div>
                        <div>
                            <strong>Questions:</strong> 
                            <span id="questionDeckCount">0</span> left
                            (<span id="questionDiscardCount">0</span> used)
                        </div>
                    </div>
                    
                    <!-- Player List -->
                    <div class="player-list" id="gamePlayers">
                    </div>
                    
                    <!-- Score Display -->
                    <div class="points-display">
                        <div class="point-item">
                            <div class="point-value" id="playerScore">0</div>
                            <div class="point-label">Your Score</div>
                        </div>
                        <div class="point-item">
                            <div class="point-value">7</div>
                            <div class="point-label">Points to Win</div>
                        </div>
                        <div class="point-item">
                            <div class="point-value" id="cardsInHand">10</div>
                            <div class="point-label">Cards in Hand</div>
                        </div>
                    </div>
                    
                    <!-- Hand Display -->
                    <h3 style="text-align: center; margin: 10px 0; font-size: 15px;">Your Hand (Click or type 1-10):</h3>
                    <div class="hand-container" id="playerHand">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn" onclick="submitCard()" id="submitBtn" disabled>
                            Submit Card
                        </button>
                        <button class="btn btn-warning" onclick="forceBotSubmission()">
                            Force Bots
                        </button>
                        <button class="btn" onclick="returnToMenu()">
                            Quit Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen 6: Judging Screen -->
        <div id="judgingScreen" class="screen">
            <div class="game-main-area">
                <div class="header">
                    <h2 style="font-size: 18px;">Judge Selection</h2>
                    <div class="card black" id="judgeQuestion">
                        Loading question...
                    </div>
                    <p style="margin: 8px 0; font-size: 14px; color: #666;">
                        Select the best answer:
                    </p>
                    <div style="color: #4CAF50; font-weight: bold; padding: 4px 10px; background: #e8f5e9; border-radius: 12px; display: inline-block; font-size: 11px;">
                        ‚öñÔ∏è You are the Judge
                    </div>
                </div>
                
                <div class="game-content">
                    <div class="judge-options" id="judgeOptions">
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="forceRandomWinner()">
                            Pick Random Winner
                        </button>
                        <button class="btn" onclick="returnToMenu()">
                            Quit Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen 7: Winner Screen -->
        <div id="winnerScreen" class="screen">
            <div class="game-main-area">
                <div class="header">
                    <h2 style="font-size: 20px;">üéâ Round Winner! üéâ</h2>
                </div>
                
                <div class="game-content">
                    <!-- Question Display on Winner Screen -->
                    <div class="card black" id="winnerQuestion">
                        Loading question...
                    </div>
                    
                    <div class="winner-announcement">
                        <div id="winnerDetails" style="margin: 10px 0; font-size: 15px;">
                        </div>
                    </div>
                    
                    <div class="all-submissions-display">
                        <h3 style="text-align: center; margin-bottom: 10px; color: #667eea; font-size: 15px;">All Submissions This Round</h3>
                        <div id="winnerSubmissions">
                        </div>
                    </div>
                    
                    <div class="points-display">
                        <div class="point-item">
                            <div class="point-value" id="winnerScore">0</div>
                            <div class="point-label">Winner's Score</div>
                        </div>
                        <div class="point-item">
                            <div class="point-value" id="roundsPlayed">1</div>
                            <div class="point-label">Rounds Played</div>
                        </div>
                        <div class="point-item">
                            <div class="point-value" id="deckSize">0</div>
                            <div class="point-label">Cards Left</div>
                        </div>
                        <div class="point-item">
                            <div class="point-value">7</div>
                            <div class="point-label">Points to Win</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="continueToNextRound()" id="nextRoundBtn">
                            Next Round
                        </button>
                        <button class="btn" onclick="returnToMenu()">
                            Back to Menu
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen 8: Card Collection -->
        <div id="collectionScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">üÉè Card Collection</h2>
                <p style="color: #666; margin-top: 6px; font-size: 13px;">Enable/disable or delete cards</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchCollectionTab('answers')">Answers</button>
                <button class="tab-button" onclick="switchCollectionTab('questions')">Questions</button>
            </div>
            
            <div id="answersTab" class="tab-content active">
                <div class="deck-info">
                    <span>Enabled: <span id="enabledAnswersCount">0</span>/<span id="totalAnswersCount">0</span></span>
                    <button class="small-btn btn-secondary" onclick="enableAllCards('answers')">
                        Enable All
                    </button>
                </div>
                
                <div class="collection-container" id="answerCollection">
                </div>
            </div>
            
            <div id="questionsTab" class="tab-content">
                <div class="deck-info">
                    <span>Enabled: <span id="enabledQuestionsCount">0</span>/<span id="totalQuestionsCount">0</span></span>
                    <button class="small-btn btn-secondary" onclick="enableAllCards('questions')">
                        Enable All
                    </button>
                </div>
                
                <div class="collection-container" id="questionCollection">
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="showScreen('menu')">
                    Back to Menu
                </button>
            </div>
        </div>
        
        <!-- Screen 9: Create Cards -->
        <div id="createScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">‚ú® Create Cards</h2>
                <p style="color: #666; margin-top: 6px; font-size: 13px;">Add custom cards to your collection</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchCreateTab('answer')">Answer Cards</button>
                <button class="tab-button" onclick="switchCreateTab('question')">Question Cards</button>
            </div>
            
            <div id="answerCreateTab" class="tab-content active">
                <div style="margin: 15px 0; flex: 1; display: flex; flex-direction: column;">
                    <textarea id="answerCreateText" class="compact-textarea" 
                              placeholder="Enter your answer card text here..."></textarea>
                    
                    <button class="btn btn-success" onclick="createCard('answer')" style="margin-top: 10px; width: 100%;">
                        ‚úÖ Create Answer Card
                    </button>
                    
                    <div style="margin-top: 10px; color: #666; font-size: 11px;">
                        <p>üí° <strong>Tips:</strong> Keep it funny and short (under 50 characters)</p>
                    </div>
                </div>
            </div>
            
            <div id="questionCreateTab" class="tab-content">
                <div style="margin: 15px 0; flex: 1; display: flex; flex-direction: column;">
                    <textarea id="questionCreateText" class="compact-textarea" 
                              placeholder="Enter your question with _____ for blanks..."></textarea>
                    
                    <div style="margin: 10px 0;">
                        <label style="font-size: 13px;">Blanks: <span style="color: #667eea; font-weight: bold;" id="createBlankCount">1</span></label>
                        <div style="margin-top: 6px;">
                            <button class="small-btn" onclick="addCreateBlank()">
                                + Add Blank
                            </button>
                            <button class="small-btn" onclick="removeCreateBlank()">
                                - Remove Blank
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="createCard('question')" style="margin-top: 10px; width: 100%;">
                        ‚úÖ Create Question Card
                    </button>
                    
                    <div style="margin-top: 10px; color: #666; font-size: 11px;">
                        <p>üí° <strong>Tips:</strong> Use _____ for blanks (1-3 blanks works best)</p>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="showScreen('menu')">
                    Back to Menu
                </button>
            </div>
        </div>
        
        <!-- Screen 10: Share Cards -->
        <div id="shareScreen" class="screen">
            <div class="header">
                <h2 style="font-size: 20px;">üîó Share Cards</h2>
                <p style="color: #666; margin-top: 6px; font-size: 13px;">Share your custom card collection</p>
            </div>
            
            <div class="game-content">
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 8px;">üéÆ Share Game Invite</h3>
                    <p style="font-size: 12px; margin-bottom: 8px;">Generate a link to invite friends to play:</p>
                    
                    <button class="btn btn-success" onclick="generateGameInviteLink()" style="margin: 6px 0; width: 100%;">
                        üéÆ Generate Game Invite Link
                    </button>
                    
                    <div id="gameInviteLinkContainer" style="display: none;">
                        <p style="font-size: 12px; margin: 8px 0 4px 0;"><strong>Game Invite Link:</strong></p>
                        <div class="share-url" id="gameInviteUrlShare"></div>
                        <button class="btn btn-secondary" onclick="copyGameInviteLink()" style="margin: 6px 0; width: 100%;">
                            üìã Copy Game Link
                        </button>
                    </div>
                </div>
                
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 8px;">üì§ Share Card Collection</h3>
                    <p style="font-size: 12px; margin-bottom: 8px;">Generate a link that includes all your custom cards.</p>
                    
                    <button class="btn btn-success" onclick="generateShareLink()" style="margin: 6px 0; width: 100%;">
                        üîó Generate Card Collection Link
                    </button>
                    
                    <div id="shareLinkContainer" style="display: none;">
                        <p style="font-size: 12px; margin: 8px 0 4px 0;"><strong>Share this link:</strong></p>
                        <div class="share-url" id="shareUrl"></div>
                        <button class="btn btn-secondary" onclick="copyShareLink()" style="margin: 6px 0; width: 100%;">
                            üìã Copy Collection Link
                        </button>
                    </div>
                </div>
                
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 8px;">üì• Import Cards</h3>
                    <p style="font-size: 12px; margin-bottom: 8px;">Paste a share URL to import cards:</p>
                    
                    <input type="text" id="importUrl" class="compact-input" 
                           placeholder="Paste share URL here..." 
                           style="margin: 6px 0; width: 100%;">
                    
                    <button class="btn btn-success" onclick="importFromUrl()" style="width: 100%;">
                        üì• Import Cards from URL
                    </button>
                </div>
                
                <div class="share-section">
                    <h3 style="font-size: 16px; margin-bottom: 8px;">üíæ File Export/Import</h3>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="exportCardsToFile()" style="flex: 1;">
                            üì§ Export to File
                        </button>
                        <button class="btn btn-secondary" onclick="importCardsFromFile()" style="flex: 1;">
                            üì• Import from File
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" onclick="showScreen('menu')">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // ==================== GLOBAL STATE ====================
        let gameState = {
            // Authentication
            user: null,
            token: null,
            isGuest: false,
            
            // Game State (YOUR ORIGINAL GAME STATE)
            playerName: "Player",
            players: [],
            currentRound: 1,
            hand: [],
            selectedCards: [],
            gamePhase: "menu",
            isJudge: false,
            deck: [],
            discardDeck: [],
            questionDeck: [],
            questionDiscard: [],
            cardCollection: {
                answers: [],
                questions: []
            },
            submittedCards: [],
            scores: {},
            winningScore: 7,
            handSize: 10,
            currentBlankCount: 1,
            activeQuestion: null,
            timeLimit: 45,
            timerRunning: false,
            timeLeft: 45,
            timerInterval: null,
            currentJudgeIndex: 0,
            playerHasSubmitted: false,
            gameActive: false,
            
            // Multiplayer
            socket: null,
            currentRoom: null,
            isHost: false,
            readyPlayers: new Set(),
            friends: [],
            onlinePlayers: []
        };
        
        let bots = {};
        
        // ==================== YOUR ORIGINAL DEFAULT CARDS ====================
        const DEFAULT_ANSWERS = [
            "A fart so powerful it wakes the dead.",
            "My weird uncle.",
            "Getting drunk on mouthwash.",
            "The miracle of childbirth.",
            "Peeing a little bit.",
            "A lifetime of regrets.",
            "Forgetting to wear pants.",
            "Selling my soul for internet fame.",
            "A suspicious rash.",
            "Cheating at Scrabble.",
            "An awkward silence.",
            "Bad decisions.",
            "The sound of children laughing.",
            "Free samples.",
            "My ex.",
            "Regret.",
            "Spaghetti.",
            "My collection of toenail clippings.",
            "Daddy issues.",
            "The patriarchy.",
            "A disappointing birthday party.",
            "Running with scissors.",
            "The entire state of Nebraska.",
            "That thing politicians do with their thumbs.",
            "Being rich.",
            "Screaming into the void.",
            "My bad attitude.",
            "Getting fingered.",
            "Grandma's ashes.",
            "The art of seduction.",
            "The Blood of Christ.",
            "One trillion dollars.",
            "Chunks of dead prostitute.",
            "A lifetime of sadness.",
            "Hormone injections.",
            "Dying alone.",
            "My good bra.",
            "Poor life choices.",
            "Cockfights.",
            "The invisible hand.",
            "Ethnic cleansing.",
            "My first kiss.",
            "Amputees.",
            "The heart of a child.",
            "Child beauty pageants.",
            "Sean Connery.",
            "An endless stream of diarrhea.",
            "The miracle of childbirth.",
            "Famine.",
            "Flesh-eating bacteria.",
            "Cultural appropriation.",
            "A balanced breakfast.",
            "Old-people smell.",
            "My cheating son-of-a-bitch husband.",
            "Pelvic thrusts.",
            "Stranger danger.",
            "Dying of dysentery.",
            "A really cool hat.",
            "The primal, ball-slapping sex your parents are having right now.",
            "A big black dick.",
            "A bigger, blacker dick.",
            "The biggest, blackest dick.",
            "A sad handjob.",
            "Police brutality.",
            "Passive-aggressive Post-it notes.",
            "Poverty.",
            "Winking at old people.",
            "Wiping her butt.",
            "Golden showers.",
            "Racism.",
            "Powerful thighs.",
            "My genitals.",
            "Preteens.",
            "More elephant cock than I bargained for.",
            "A micropenis.",
            "My ugly face and bad personality.",
            "A good sniff.",
            "Incest.",
            "Agriculture.",
            "Foreskin.",
            "A homoerotic volleyball montage.",
            "Actually taking candy from a baby.",
            "Crystal meth.",
            "Exactly what you'd expect.",
            "Natural male enhancement.",
            "Poor people.",
            "The violation of our most basic human rights.",
            "Viagra.",
            "Self-loathing.",
            "Spectacular abs.",
            "An honest cop with nothing left to lose.",
            "Abstinence.",
            "A balanced diet.",
            "Mild autism.",
            "Necrophilia.",
            "A can of whoop-ass.",
            "A windmill full of corpses.",
            "Whipping it out.",
            "Academy Award winner Meryl Streep.",
            "Obesity.",
            "Object permanence.",
            "Opposable thumbs.",
            "Riding off into the sunset.",
            "The hiccups.",
            "The Holy Bible.",
            "Puberty.",
            // Additional 50 answer cards
            "An unexpected cactus in the butt.",
            "The screams of the damned.",
            "A really aggressive duck.",
            "My secret collection of belly button lint.",
            "The smell of regret.",
            "A suspiciously sticky keyboard.",
            "Trying to fit in.",
            "The cold embrace of the void.",
            "A questionable life choice.",
            "The art of subtlety.",
            "My extensive collection of rubber chickens.",
            "The undeniable urge to dance.",
            "A poorly timed sneeze.",
            "The sweet release of death.",
            "My questionable taste in music.",
            "The overwhelming urge to lick things.",
            "A surprise party for no one.",
            "The existential dread of existence.",
            "My questionable hygiene habits.",
            "The sound of silence.",
            "A conspiracy theory about pigeons.",
            "The crushing weight of expectation.",
            "My awkward phase.",
            "The thrill of the chase.",
            "A poorly constructed lie.",
            "The monotony of daily life.",
            "My irrational fear of spoons.",
            "The beauty of imperfection.",
            "A sudden burst of confidence.",
            "The lingering smell of failure.",
            "My questionable fashion choices.",
            "The inevitable heat death of the universe.",
            "A poorly executed plan.",
            "The sweet taste of victory.",
            "My collection of weird rocks.",
            "The constant need for validation.",
            "A surprise twist ending.",
            "The uncomfortable truth.",
            "My questionable life decisions.",
            "The beauty of simplicity.",
            "A poorly timed joke.",
            "The overwhelming power of love.",
            "My secret stash of chocolate.",
            "The relentless march of time.",
            "A questionable political opinion.",
            "The sweet sound of success.",
            "My collection of random facts.",
            "The undeniable truth.",
            "A poorly chosen tattoo.",
            "The eternal struggle."
        ];
        
        const DEFAULT_QUESTIONS = [
            "What's that smell? _____",
            "What ruined the bachelor party? _____",
            "What's Grandpa hiding in the attic? _____",
            "What's the secret to a happy marriage? _____",
            "What did I bring back from Mexico? _____",
            "What's my secret power? _____",
            "What never fails to make me smile? _____",
            "What's in my basement? _____",
            "What's the worst gift I've ever received? _____",
            "What do I bring to a potluck? _____",
            "What's the next superhero movie about? _____",
            "What ended my last relationship? _____",
            "What's always on my Christmas list? _____",
            "What's my guilty pleasure? _____",
            "What will I bring back in time to convince people I'm a god? _____",
            "What would grandma find disturbing, yet oddly charming? _____",
            "What helps Obama unwind? _____",
            "What did I exchange my soul for? _____",
            "What's the new fad diet? _____",
            "What gives me uncontrollable gas? _____",
            "What do old people smell like? _____",
            "What am I giving up for Lent? _____",
            "What's that sound? _____",
            "What made my first kiss so awkward? _____",
            "What never fails to liven up the party? _____",
            "What will always get you laid? _____",
            "What would I wish for if I had three wishes? _____",
            "What's the best way to get over a breakup? _____",
            "What's hiding under my bed? _____",
            "What's the secret to a long life? _____",
            "What's my spirit animal? _____",
            "What's the worst thing to find in your hotel room? _____",
            "What's the best thing about waking up early? _____",
            "What's my go-to karaoke song? _____",
            "What's the key to success? _____",
            "What's in my secret stash? _____",
            "What's the real reason I got fired? _____",
            "What's my super villain origin story? _____",
            "What's the best part of waking up? _____",
            "What's my favorite childhood memory? _____",
            "What's the meaning of life? _____",
            "What's the worst thing you can say on a first date? _____",
            "What's my hidden talent? _____",
            "What's the secret ingredient in my famous chili? _____",
            "What's my biggest regret? _____",
            // Additional 20 question cards
            "What's my secret to staying young? _____",
            "What will be the title of my autobiography? _____",
            "What's always in my refrigerator? _____",
            "What's my weirdest habit? _____",
            "What would I do with a million dollars? _____",
            "What's my superpower? _____",
            "What's the worst advice I've ever received? _____",
            "What's my favorite way to waste time? _____",
            "What's in my backpack right now? _____",
            "What's the key to a good relationship? _____",
            "What's my morning routine? _____",
            "What's my ultimate comfort food? _____",
            "What's the weirdest dream I've ever had? _____",
            "What's my secret talent? _____",
            "What's my guilty pleasure TV show? _____",
            "What's the best part of my day? _____",
            "What's my philosophy on life? _____",
            "What's my favorite way to relax? _____",
            "What's the most embarrassing thing in my search history? _____",
            "What's my favorite memory from high school? _____"
        ];
        
        // ==================== YOUR ORIGINAL FUNCTIONS ====================
        function initializeCardCollection() {
            const savedCollection = localStorage.getItem('cardCollection');
            
            if (savedCollection) {
                try {
                    gameState.cardCollection = JSON.parse(savedCollection);
                    
                    // Ensure all default cards are present
                    const currentAnswerTexts = gameState.cardCollection.answers.map(c => c.text.toLowerCase());
                    const currentQuestionTexts = gameState.cardCollection.questions.map(c => c.text.toLowerCase());
                    
                    // Add missing default answers
                    DEFAULT_ANSWERS.forEach(text => {
                        if (!currentAnswerTexts.includes(text.toLowerCase())) {
                            gameState.cardCollection.answers.push({
                                text: text,
                                enabled: true,
                                isDefault: true
                            });
                        }
                    });
                    
                    // Add missing default questions
                    DEFAULT_QUESTIONS.forEach(text => {
                        if (!currentQuestionTexts.includes(text.toLowerCase())) {
                            gameState.cardCollection.questions.push({
                                text: text,
                                enabled: true,
                                isDefault: true
                            });
                        }
                    });
                    
                    saveCardCollection();
                    console.log("üì¶ Loaded and repaired card collection");
                } catch (e) {
                    console.error("Error loading saved collection, creating fresh one:", e);
                    createDefaultCollection();
                }
            } else {
                createDefaultCollection();
            }
            
            updateMenuStats();
        }
        
        function createDefaultCollection() {
            gameState.cardCollection = {
                answers: DEFAULT_ANSWERS.map(text => ({
                    text: text,
                    enabled: true,
                    isDefault: true
                })),
                questions: DEFAULT_QUESTIONS.map(text => ({
                    text: text,
                    enabled: true,
                    isDefault: true
                }))
            };
            saveCardCollection();
            console.log("üì¶ Created fresh default card collection");
        }
        
        function saveCardCollection() {
            localStorage.setItem('cardCollection', JSON.stringify(gameState.cardCollection));
            updateMenuStats();
        }
        
        function updateMenuStats() {
            const totalAnswers = gameState.cardCollection.answers.length;
            const totalQuestions = gameState.cardCollection.questions.length;
            const customAnswers = gameState.cardCollection.answers.filter(c => !c.isDefault).length;
            const customQuestions = gameState.cardCollection.questions.filter(c => !c.isDefault).length;
            
            document.getElementById('menuAnswerCount').textContent = totalAnswers;
            document.getElementById('menuQuestionCount').textContent = totalQuestions;
            document.getElementById('menuCustomCount').textContent = customAnswers + customQuestions;
        }
function startGameFromLobby() {
  console.log('=== START GAME DEBUG ===');
  console.log('Room:', gameState.currentRoom?.code);
  console.log('Socket:', !!gameState.socket);
  console.log('Host flag:', gameState.isHost);
  
  // Quick check: are we even connected?
  if (!gameState.currentRoom || !gameState.socket) {
    alert('Not connected to a room!');
    return;
  }
  
  // EMERGENCY: Just try it anyway!
  console.log('üöÄ Sending start_game to server...');
  gameState.socket.emit('start_game', {
    roomCode: gameState.currentRoom.code
  });
  
  alert('Start game request sent to server!');
}

// Socket listeners for game events
if (gameState.socket) {
  gameState.socket.on('game_started', (data) => {
    console.log('‚úÖ Game started!', data);
    showScreen('game');
  });

  gameState.socket.on('game_error', (data) => {
    alert('‚ùå Game error: ' + data.message);
  });
    // Socket listeners for game events
if (gameState.socket) {
  gameState.socket.on('game_started', (data) => {
    console.log('‚úÖ Game started!', data);
    
    // Initialize multiplayer game
    gameState.gamePhase = "playing";
    gameState.gameActive = true;
    gameState.players = data.room.players;
    gameState.currentRound = 1;
    gameState.isJudge = data.room.judgeIndex === 0;
    
    showScreen('game');
    startRound();  // Start first round
  });

  gameState.socket.on('game_error', (data) => {
    alert('‚ùå Game error: ' + data.message);
  });
}
        // ==================== YOUR ORIGINAL GAME FUNCTIONS ====================
        function startSolitaireGame() {
            console.log("üéÆ Starting solitaire game with 3 bots...");
            
            const playerName = gameState.user ? gameState.user.username : "Player";
            gameState.playerName = playerName;
            
            // Initialize decks FIRST
            initializeDecks();
            
            // Reset game state
            gameState.players = [];
            gameState.currentRound = 1;
            gameState.hand = [];
            gameState.selectedCards = [];
            gameState.submittedCards = [];
            gameState.scores = {};
            gameState.playerHasSubmitted = false;
            gameState.currentJudgeIndex = 0;
            gameState.gameActive = true;
            gameState.gamePhase = "playing";
            
            // Create players - Now with 3 bots
            const humanPlayer = {
                id: 'player_human',
                name: playerName,
                isHost: true,
                score: 0,
                isBot: false
            };
            
            const bot1 = {
                id: 'bot_alice',
                name: 'Bot Alice',
                isHost: false,
                score: 0,
                isBot: true
            };
            
            const bot2 = {
                id: 'bot_bob',
                name: 'Bot Bob',
                isHost: false,
                score: 0,
                isBot: true
            };
            
            const bot3 = {
                id: 'bot_charlie',
                name: 'Bot Charlie',
                isHost: false,
                score: 0,
                isBot: true
            };
            
            gameState.players = [humanPlayer, bot1, bot2, bot3];
            
            // Initialize scores
            gameState.players.forEach(player => {
                gameState.scores[player.id] = 0;
            });
            
            // Initialize bots
            bots = {};
            const personalities = ['funny', 'risky', 'safe', 'random'];
            
            gameState.players.forEach(player => {
                if (player.isBot) {
                    const personality = personalities[Math.floor(Math.random() * personalities.length)];
                    bots[player.id] = new SmartBot(player.id, player.name, personality);
                }
            });
            
            // Random judge
            gameState.currentJudgeIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.isJudge = (gameState.players[gameState.currentJudgeIndex].id === 'player_human');
            
            console.log("Judge:", gameState.players[gameState.currentJudgeIndex].name);
            
            // Deal hands (10 cards each)
            dealHands();
            
            // Start first round
            startRound();
            
            // Show game screen
            showScreen('game');
        }
        
        class SmartBot {
            constructor(id, name, personality = 'random') {
                this.id = id;
                this.name = name;
                this.personality = personality;
                this.hand = [];
                this.isBot = true;
                this.hasSubmitted = false;
                this.memory = [];
            }
            
            setHand(cards) {
                this.hand = [...cards];
                this.hasSubmitted = false;
            }
            
            refillHand() {
                while (this.hand.length < gameState.handSize) {
                    const card = drawAnswerCard();
                    if (card) {
                        this.hand.push(card);
                    } else {
                        break;
                    }
                }
            }
            
            selectCards(blankCount) {
                const scoredCards = this.hand.map((card, index) => {
                    let score = Math.random() * 10;
                    return { index, card, score };
                });
                
                scoredCards.sort((a, b) => b.score - a.score);
                const selected = scoredCards.slice(0, blankCount).map(c => c.index);
                
                if (selected.length === 0 && this.hand.length > 0) {
                    const indices = [];
                    while (indices.length < Math.min(blankCount, this.hand.length)) {
                        const randomIndex = Math.floor(Math.random() * this.hand.length);
                        if (!indices.includes(randomIndex)) {
                            indices.push(randomIndex);
                        }
                    }
                    return indices;
                }
                
                return selected;
            }
            
            getSubmissionText(selectedIndices) {
                if (selectedIndices.length === 0) return "No card selected";
                if (selectedIndices.length === 1) {
                    return this.hand[selectedIndices[0]];
                } else {
                    return selectedIndices.map(idx => this.hand[idx]);
                }
            }
            
            removeSelectedCards(selectedIndices) {
                const sortedIndices = [...selectedIndices].sort((a, b) => b - a);
                sortedIndices.forEach(index => {
                    if (index >= 0 && index < this.hand.length) {
                        this.rememberCard(this.hand[index]);
                        this.hand.splice(index, 1);
                    }
                });
            }
            
            rememberCard(card) {
                this.memory.push(card);
                if (this.memory.length > 10) {
                    this.memory.shift();
                }
            }
        }
        
        function initializeDecks() {
            // Build answer deck from ENABLED cards only
            const enabledAnswers = gameState.cardCollection.answers
                .filter(card => card.enabled)
                .map(card => card.text);
            
            // Build question deck from ENABLED cards only
            const enabledQuestions = gameState.cardCollection.questions
                .filter(card => card.enabled)
                .map(card => card.text);
            
            // Shuffle decks
            gameState.deck = shuffleArray([...enabledAnswers]);
            gameState.questionDeck = shuffleArray([...enabledQuestions]);
            
            // Reset discard piles
            gameState.discardDeck = [];
            gameState.questionDiscard = [];
            
            console.log("üÉè Decks initialized with", gameState.deck.length, "answers and", gameState.questionDeck.length, "questions");
            updateDeckInfo();
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function drawAnswerCard() {
            if (gameState.deck.length === 0) {
                reshuffleDecks();
            }
            
            if (gameState.deck.length === 0) {
                console.warn("‚ö†Ô∏è No answer cards available!");
                return null;
            }
            
            const card = gameState.deck.shift();
            gameState.discardDeck.push(card);
            updateDeckInfo();
            return card;
        }
        
        function drawQuestionCard() {
            if (gameState.questionDeck.length === 0) {
                reshuffleDecks();
            }
            
            if (gameState.questionDeck.length === 0) {
                console.warn("‚ö†Ô∏è No question cards available!");
                return DEFAULT_QUESTIONS[0]; // Fallback
            }
            
            const card = gameState.questionDeck.shift();
            gameState.questionDiscard.push(card);
            updateDeckInfo();
            return card;
        }
        
        function reshuffleDecks() {
            console.log("üîÑ Reshuffling decks...");
            
            if (gameState.discardDeck.length > 0) {
                gameState.deck = shuffleArray([...gameState.discardDeck]);
                gameState.discardDeck = [];
            }
            
            if (gameState.questionDiscard.length > 0) {
                gameState.questionDeck = shuffleArray([...gameState.questionDiscard]);
                gameState.questionDiscard = [];
            }
            
            // If still empty, reinitialize from collection
            if (gameState.deck.length === 0) {
                const enabledAnswers = gameState.cardCollection.answers
                    .filter(card => card.enabled)
                    .map(card => card.text);
                gameState.deck = shuffleArray([...enabledAnswers]);
            }
            
            if (gameState.questionDeck.length === 0) {
                const enabledQuestions = gameState.cardCollection.questions
                    .filter(card => card.enabled)
                    .map(card => card.text);
                gameState.questionDeck = shuffleArray([...enabledQuestions]);
            }
            
            updateDeckInfo();
        }
        
        function dealHands() {
            // Deal to human (10 cards)
            gameState.hand = [];
            for (let i = 0; i < gameState.handSize; i++) {
                const card = drawAnswerCard();
                if (card) {
                    gameState.hand.push(card);
                }
            }
            
            // Deal to bots (10 cards each)
            Object.values(bots).forEach(bot => {
                const hand = [];
                for (let i = 0; i < gameState.handSize; i++) {
                    const card = drawAnswerCard();
                    if (card) {
                        hand.push(card);
                    }
                }
                bot.setHand(hand);
            });
            
            updatePlayerHand();
            updateGamePlayers();
            updateDeckInfo();
        }
        
        function startRound() {
            gameState.gamePhase = "playing";
            gameState.submittedCards = [];
            gameState.selectedCards = [];
            gameState.playerHasSubmitted = false;
            
            // Get question
            const question = drawQuestionCard();
            gameState.activeQuestion = question;
            gameState.currentBlankCount = (question.match(/_____/g) || []).length || 1;
            
            // Reset bot submission status
            Object.values(bots).forEach(bot => {
                bot.hasSubmitted = false;
            });
            
            // Update UI
            document.getElementById('questionDisplay').textContent = question;
            document.getElementById('roundNumber').textContent = gameState.currentRound;
            document.getElementById('currentJudgeName').textContent = gameState.players[gameState.currentJudgeIndex].name;
            document.getElementById('nextRoundBtn').style.display = 'inline-block';
            
            updateStatusText();
            startTimer();
            updateGameUI();
        }
        
        function startTimer() {
            stopTimer();
            gameState.timeLeft = gameState.timeLimit;
            gameState.timerRunning = true;
            
            updateTimerDisplay();
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    stopTimer();
                    if (!gameState.playerHasSubmitted && !gameState.isJudge) {
                        autoSubmitCard();
                    }
                    setTimeout(checkIfReadyForJudging, 1000);
                }
            }, 1000);
        }
        
        function stopTimer() {
            gameState.timerRunning = false;
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            if (!timerDisplay) return;
            
            if (!gameState.timerRunning) {
                timerDisplay.textContent = "--:--";
                return;
            }
            
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (gameState.timeLeft <= 10) {
                timerDisplay.className = 'timer danger';
            } else if (gameState.timeLeft <= 30) {
                timerDisplay.className = 'timer warning';
            } else {
                timerDisplay.className = 'timer';
            }
        }
        
        function updatePlayerHand() {
            const handContainer = document.getElementById('playerHand');
            if (!handContainer) return;
            
            handContainer.innerHTML = '';
            
            gameState.hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                if (gameState.selectedCards.includes(index)) {
                    cardDiv.classList.add('selected');
                }
                
                cardDiv.innerHTML = `
                    <div class="card-number">${index + 1}</div>
                    <div style="display: inline-block; font-size: 13px;">${card}</div>
                `;
                
                cardDiv.onclick = () => selectCard(index);
                handContainer.appendChild(cardDiv);
            });
            
            document.getElementById('cardsInHand').textContent = gameState.hand.length;
            updateSubmitButton();
        }
        
        function selectCard(index) {
            if (gameState.isJudge) {
                alert("You are the judge! You cannot submit cards this round.");
                return;
            }
            
            if (gameState.playerHasSubmitted) {
                alert("You have already submitted for this round!");
                return;
            }
            
            if (gameState.selectedCards.includes(index)) {
                gameState.selectedCards = gameState.selectedCards.filter(i => i !== index);
            } else {
                if (gameState.selectedCards.length < gameState.currentBlankCount) {
                    gameState.selectedCards.push(index);
                } else {
                    alert(`You can only select ${gameState.currentBlankCount} card(s) for this question. Deselect one first.`);
                    return;
                }
            }
            
            updatePlayerHand();
            updateStatusText();
        }
        
        function updateStatusText() {
            const statusText = document.getElementById('statusText');
            const selectedCountInfo = document.getElementById('selectedCountInfo');
            
            if (gameState.isJudge) {
                statusText.textContent = "You are the judge. Waiting for submissions...";
                selectedCountInfo.textContent = "";
            } else if (gameState.playerHasSubmitted) {
                statusText.textContent = "Card submitted! Waiting for bots...";
                selectedCountInfo.textContent = "";
            } else {
                statusText.textContent = "Select card(s) from your hand";
                selectedCountInfo.textContent = `${gameState.selectedCards.length}/${gameState.currentBlankCount}`;
            }
        }
        
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (!submitBtn) return;
            
            if (gameState.isJudge) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Judge (Cannot Submit)";
                return;
            }
            
            if (gameState.playerHasSubmitted) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Already Submitted";
                return;
            }
            
            const hasEnoughCards = gameState.selectedCards.length === gameState.currentBlankCount;
            submitBtn.disabled = !hasEnoughCards;
            submitBtn.textContent = hasEnoughCards ? 
                `Submit Card (${gameState.selectedCards.length} selected)` : 
                `Select ${gameState.currentBlankCount} Card(s)`;
        }
        
        function submitCard() {
            if (gameState.isJudge) {
                alert("You are the judge! You cannot submit cards this round.");
                return;
            }
            
            if (gameState.selectedCards.length !== gameState.currentBlankCount) {
                alert(`Please select exactly ${gameState.currentBlankCount} card(s) for this question.`);
                return;
            }
            
            if (gameState.playerHasSubmitted) {
                alert("You have already submitted for this round!");
                return;
            }
            
            const selectedCardTexts = gameState.selectedCards.map(index => gameState.hand[index]);
            
            const sortedIndices = [...gameState.selectedCards].sort((a, b) => b - a);
            sortedIndices.forEach(index => {
                gameState.hand.splice(index, 1);
            });
            
            for (let i = 0; i < sortedIndices.length; i++) {
                const newCard = drawAnswerCard();
                if (newCard) {
                    gameState.hand.push(newCard);
                }
            }
            
            gameState.submittedCards.push({
                player: gameState.playerName,
                playerId: 'player_human',
                card: selectedCardTexts.length === 1 ? selectedCardTexts[0] : selectedCardTexts
            });
            
            gameState.playerHasSubmitted = true;
            gameState.selectedCards = [];
            
            updatePlayerHand();
            updateStatusText();
            updateDeckInfo();
            updateGamePlayers();
            
            setTimeout(() => {
                submitBotsCards();
            }, 1500);
        }
        
        function autoSubmitCard() {
            if (gameState.isJudge || gameState.playerHasSubmitted) return;
            
            if (gameState.selectedCards.length === 0 && gameState.hand.length > 0) {
                // Auto-select first card if none selected
                if (gameState.currentBlankCount === 1) {
                    gameState.selectedCards = [0];
                } else {
                    const indices = [];
                    for (let i = 0; i < Math.min(gameState.currentBlankCount, gameState.hand.length); i++) {
                        indices.push(i);
                    }
                    gameState.selectedCards = indices;
                }
            }
            
            if (gameState.selectedCards.length > 0) {
                submitCard();
            }
        }
        
        function submitBotsCards() {
            Object.values(bots).forEach(bot => {
                if (bot.hasSubmitted) return;
                
                const isBotJudge = gameState.players[gameState.currentJudgeIndex].id === bot.id;
                if (isBotJudge) return;
                
                const selectedIndices = bot.selectCards(gameState.currentBlankCount);
                if (selectedIndices.length === 0) return;
                
                const submissionCards = bot.getSubmissionText(selectedIndices);
                
                gameState.submittedCards.push({
                    player: bot.name,
                    playerId: bot.id,
                    card: submissionCards
                });
                
                bot.removeSelectedCards(selectedIndices);
                bot.refillHand();
                bot.hasSubmitted = true;
            });
            
            updateGamePlayers();
            updateDeckInfo();
            
            setTimeout(checkIfReadyForJudging, 1000);
        }
        
        function forceBotSubmission() {
            submitBotsCards();
        }
        
        function checkIfReadyForJudging() {
            if (gameState.gamePhase !== 'playing') return;
            
            const judge = gameState.players[gameState.currentJudgeIndex];
            if (!judge) return;
            
            const playersWhoShouldSubmit = gameState.players.filter(p => p.id !== judge.id);
            const submittedPlayerIds = gameState.submittedCards.map(s => s.playerId);
            
            const allSubmitted = playersWhoShouldSubmit.every(player => 
                submittedPlayerIds.includes(player.id)
            );
            
            if (allSubmitted && playersWhoShouldSubmit.length > 0) {
                startJudging();
            } else {
                setTimeout(checkIfReadyForJudging, 1000);
            }
        }
        
        function startJudging() {
            gameState.gamePhase = "judging";
            stopTimer();
            
            if (gameState.isJudge) {
                showScreen('judging');
                displayJudgeOptions();
            } else {
                setTimeout(() => {
                    if (gameState.submittedCards.length > 0) {
                        const randomIndex = Math.floor(Math.random() * gameState.submittedCards.length);
                        selectWinner(randomIndex);
                    }
                }, 2000);
            }
        }
        
        function displayJudgeOptions() {
            const question = gameState.activeQuestion || "What's that smell? _____";
            document.getElementById('judgeQuestion').textContent = question;
            
            const optionsContainer = document.getElementById('judgeOptions');
            optionsContainer.innerHTML = '';
            
            gameState.submittedCards.forEach((submission, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'judge-option';
                
                let answersHTML = '';
                if (Array.isArray(submission.card)) {
                    answersHTML = `
                        <div class="multi-answer-container">
                            ${submission.card.map((card, i) => `
                                <div class="answer-item">
                                    <div class="answer-number">${i + 1}</div>
                                    <div style="font-size: 13px;">${card}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    answersHTML = `<div style="font-size: 14px; margin: 4px 0;">${submission.card}</div>`;
                }
                
                optionDiv.innerHTML = `
                    <div style="font-size: 16px; color: #667eea; margin-bottom: 4px;">Option ${index + 1}</div>
                    ${answersHTML}
                    <div style="color: #666; font-size: 11px; margin-top: 4px;">From: ${submission.player}</div>
                `;
                
                optionDiv.onclick = () => selectWinner(index);
                optionsContainer.appendChild(optionDiv);
            });
        }
        
        function selectWinner(index) {
            if (index < 0 || index >= gameState.submittedCards.length) return;
            
            const winner = gameState.submittedCards[index];
            
            if (gameState.scores[winner.playerId] !== undefined) {
                gameState.scores[winner.playerId]++;
            } else {
                gameState.scores[winner.playerId] = 1;
            }
            
            const gameWinner = checkForGameWinner();
            
            gameState.currentJudgeIndex = (gameState.currentJudgeIndex + 1) % gameState.players.length;
            gameState.isJudge = (gameState.players[gameState.currentJudgeIndex].id === 'player_human');
            
            showWinnerScreen(winner, gameWinner);
        }
        
        function forceRandomWinner() {
            if (gameState.submittedCards.length === 0) {
                alert("No submissions to judge!");
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * gameState.submittedCards.length);
            selectWinner(randomIndex);
        }
        
        function checkForGameWinner() {
            for (const [playerId, score] of Object.entries(gameState.scores)) {
                if (score >= gameState.winningScore) {
                    return playerId;
                }
            }
            return null;
        }
        
        function showWinnerScreen(winner, gameWinner) {
            gameState.gamePhase = "winner";
            
            // Set question on winner screen
            document.getElementById('winnerQuestion').textContent = gameState.activeQuestion;
            
            displayAllSubmissions('winnerSubmissions');
            
            let winnerText = '';
            if (Array.isArray(winner.card)) {
                winnerText = winner.card.map((card, i) => `
                    <div style="margin: 3px 0; padding-left: 12px; font-size: 14px;">
                        <span style="color: #FFD700; font-weight: bold;">${i + 1}.</span> ${card}
                    </div>
                `).join('');
            } else {
                winnerText = `<div style="font-size: 16px; margin: 6px 0;">"${winner.card}"</div>`;
            }
            
            document.getElementById('winnerDetails').innerHTML = `
                <div style="color: #4CAF50; font-weight: bold; font-size: 15px;">Winner: ${winner.player}</div>
                ${winnerText}
                <div style="margin-top: 6px; color: #4CAF50; font-weight: bold;">üéâ Round Winner! üéâ</div>
            `;
            
            const winnerScore = gameState.scores[winner.playerId] || 0;
            document.getElementById('winnerScore').textContent = winnerScore;
            document.getElementById('roundsPlayed').textContent = gameState.currentRound;
            document.getElementById('deckSize').textContent = gameState.deck.length;
            
            if (gameWinner) {
                const winnerPlayer = gameState.players.find(p => p.id === gameWinner);
                if (winnerPlayer) {
                    document.getElementById('winnerDetails').innerHTML += `
                        <div style="margin-top: 10px; font-size: 18px; color: #FFD700;">
                            üèÜ GAME WINNER: ${winnerPlayer.name}! üèÜ
                        </div>
                        <div style="color: #666; font-size: 13px;">Final Score: ${gameState.scores[gameWinner]} points (First to 7)</div>
                    `;
                    document.getElementById('nextRoundBtn').style.display = 'none';
                    gameState.gameActive = false;
                }
            } else {
                document.getElementById('nextRoundBtn').style.display = 'inline-block';
            }
            
            showScreen('winner');
        }
        
        function continueToNextRound() {
            if (!gameState.gameActive) {
                alert("Game has ended. Start a new game from the menu.");
                return;
            }
            
            gameState.currentRound++;
            gameState.submittedCards = [];
            gameState.selectedCards = [];
            gameState.playerHasSubmitted = false;
            
            Object.values(bots).forEach(bot => {
                bot.hasSubmitted = false;
            });
            
            while (gameState.hand.length < gameState.handSize) {
                const card = drawAnswerCard();
                if (card) {
                    gameState.hand.push(card);
                } else {
                    break;
                }
            }
            
            Object.values(bots).forEach(bot => {
                bot.refillHand();
            });
            
            startRound();
            showScreen('game');
        }
        
        function updateDeckInfo() {
            if (document.getElementById('answerDeckCount')) {
                document.getElementById('answerDeckCount').textContent = gameState.deck.length;
                document.getElementById('answerDiscardCount').textContent = gameState.discardDeck.length;
                document.getElementById('questionDeckCount').textContent = gameState.questionDeck.length;
                document.getElementById('questionDiscardCount').textContent = gameState.questionDiscard.length;
            }
        }
        
        function updateGameUI() {
            document.getElementById('playerScore').textContent = gameState.scores['player_human'] || 0;
            document.getElementById('roundNumber').textContent = gameState.currentRound;
            updateDeckInfo();
        }
        
        function updateGamePlayers() {
            const container = document.getElementById('gamePlayers');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-card ${player.id === 'player_human' ? 'host' : ''} ${gameState.players[gameState.currentJudgeIndex].id === player.id ? 'judge' : ''}`;
                
                const hasSubmitted = gameState.submittedCards.some(s => s.playerId === player.id);
                
                playerDiv.innerHTML = `
                    <div style="font-weight: bold; font-size: 12px;">${player.name}</div>
                    <div class="score-display" style="font-size: 13px;">Score: ${gameState.scores[player.id] || 0}</div>
                    <div style="font-size: 10px; color: ${hasSubmitted ? '#4CAF50' : '#f44336'}; margin-top: 2px;">
                        ${hasSubmitted ? '‚úÖ Submitted' : '‚è≥ Waiting'}
                    </div>
                `;
                
                container.appendChild(playerDiv);
            });
        }
        
        function displayAllSubmissions(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.submittedCards.forEach((submission, index) => {
                const submissionDiv = document.createElement('div');
                submissionDiv.className = 'submission-item';
                
                let answersHTML = '';
                if (Array.isArray(submission.card)) {
                    answersHTML = `
                        <div class="multi-answer-container">
                            ${submission.card.map((card, i) => `
                                <div class="answer-item">
                                    <div class="answer-number">${i + 1}</div>
                                    <div style="font-size: 13px;">${card}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    answersHTML = `<div style="font-size: 14px; margin: 4px 0;">${submission.card}</div>`;
                }
                
                submissionDiv.innerHTML = `
                    <div style="font-weight: bold; color: #667eea; margin-bottom: 4px; font-size: 13px;">
                        ${submission.player}
                    </div>
                    ${answersHTML}
                `;
                
                container.appendChild(submissionDiv);
            });
        }
        
        // ==================== YOUR ORIGINAL CARD CREATION FUNCTIONS ====================
        function createCard(type) {
            let textarea, collection;
            
            if (type === 'answer') {
                textarea = document.getElementById('answerCreateText');
                collection = gameState.cardCollection.answers;
            } else {
                textarea = document.getElementById('questionCreateText');
                collection = gameState.cardCollection.questions;
            }
            
            const cardText = textarea.value.trim();
            
            if (!cardText) {
                alert("Please enter card text");
                return;
            }
            
            const alreadyExists = collection.some(card => 
                card.text.toLowerCase() === cardText.toLowerCase()
            );
            
            if (alreadyExists) {
                alert("This card already exists in your collection!");
                return;
            }
            
            collection.push({
                text: cardText,
                enabled: true,
                isDefault: false
            });
            
            saveCardCollection();
            
            textarea.value = '';
            if (type === 'question') {
                document.getElementById('createBlankCount').textContent = '1';
            }
            
            alert("‚úÖ Card added to your collection!");
            
            if (document.getElementById('collectionScreen').classList.contains('active')) {
                refreshCollection();
            }
            
            updateMenuStats();
            console.log("Created new", type, "card:", cardText);
        }
        
        function addCreateBlank() {
            const textarea = document.getElementById('questionCreateText');
            textarea.value = textarea.value + ' _____';
            document.getElementById('createBlankCount').textContent = 
                parseInt(document.getElementById('createBlankCount').textContent) + 1;
        }
        
        function removeCreateBlank() {
            const textarea = document.getElementById('questionCreateText');
            const blankCount = document.getElementById('createBlankCount');
            
            if (parseInt(blankCount.textContent) <= 1) return;
            
            const text = textarea.value;
            const lastBlankIndex = text.lastIndexOf('_____');
            if (lastBlankIndex !== -1) {
                textarea.value = text.substring(0, lastBlankIndex).trim();
                blankCount.textContent = parseInt(blankCount.textContent) - 1;
            }
        }
        
        // ==================== YOUR ORIGINAL SHARING FUNCTIONS ====================
        function generateGameInviteLink() {
            const playerName = gameState.user ? gameState.user.username : "Player";
            const currentUrl = window.location.origin + window.location.pathname;
            
            const inviteData = {
                type: 'game_invite',
                player: playerName,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(inviteData);
            const compressed = btoa(encodeURIComponent(jsonString));
            const inviteUrl = `${currentUrl}?invite=${compressed}`;
            
            document.getElementById('gameInviteUrlShare').textContent = inviteUrl;
            document.getElementById('gameInviteLinkContainer').style.display = 'block';
            
            alert("üéÆ Game invite link generated! Share this with friends.");
        }
        
        function copyGameInviteLink() {
            const inviteUrl = document.getElementById('gameInviteUrlShare').textContent;
            
            if (inviteUrl) {
                navigator.clipboard.writeText(inviteUrl).then(() => {
                    alert("‚úÖ Game invite link copied to clipboard!");
                }).catch(() => {
                    prompt("Copy this game invite link:", inviteUrl);
                });
            }
        }
        
        function generateShareLink() {
            const customCards = {
                answers: gameState.cardCollection.answers
                    .filter(card => !card.isDefault && card.enabled)
                    .map(card => card.text),
                questions: gameState.cardCollection.questions
                    .filter(card => !card.isDefault && card.enabled)
                    .map(card => card.text)
            };
            
            if (customCards.answers.length === 0 && customCards.questions.length === 0) {
                alert("You haven't created any custom cards yet! Create some cards first.");
                return;
            }
            
            const shareData = {
                v: '1.0',
                d: new Date().toISOString().split('T')[0],
                a: customCards.answers,
                q: customCards.questions
            };
            
            const jsonString = JSON.stringify(shareData);
            const compressed = btoa(encodeURIComponent(jsonString));
            
            const currentUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${currentUrl}?cards=${compressed}`;
            
            document.getElementById('shareUrl').textContent = shareUrl;
            document.getElementById('shareLinkContainer').style.display = 'block';
        }
        
        function copyShareLink() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("‚úÖ Link copied to clipboard! Send this to your friends.");
            }).catch(() => {
                prompt("Copy this link:", shareUrl);
            });
        }
        
        function importFromUrl() {
            const urlInput = document.getElementById('importUrl').value.trim();
            
            if (!urlInput) {
                alert("Please paste a share URL");
                return;
            }
            
            try {
                const url = new URL(urlInput);
                const cardsParam = url.searchParams.get('cards');
                
                if (!cardsParam) {
                    alert("This URL doesn't contain any cards to import");
                    return;
                }
                
                const decoded = decodeURIComponent(atob(cardsParam));
                const imported = JSON.parse(decoded);
                
                let addedAnswers = 0;
                let addedQuestions = 0;
                
                if (imported.a && Array.isArray(imported.a)) {
                    imported.a.forEach(answer => {
                        if (!gameState.cardCollection.answers.some(c => 
                            c.text.toLowerCase() === answer.toLowerCase())) {
                            gameState.cardCollection.answers.push({
                                text: answer,
                                enabled: true,
                                isDefault: false
                            });
                            addedAnswers++;
                        }
                    });
                }
                
                if (imported.q && Array.isArray(imported.q)) {
                    imported.q.forEach(question => {
                        if (!gameState.cardCollection.questions.some(c => 
                            c.text.toLowerCase() === question.toLowerCase())) {
                            gameState.cardCollection.questions.push({
                                text: question,
                                enabled: true,
                                isDefault: false
                            });
                            addedQuestions++;
                        }
                    });
                }
                
                saveCardCollection();
                refreshCollection();
                document.getElementById('importUrl').value = '';
                
                if (addedAnswers === 0 && addedQuestions === 0) {
                    alert("You already have all these cards in your collection!");
                } else {
                    alert(`‚úÖ Imported ${addedAnswers} new answer cards and ${addedQuestions} new question cards!`);
                }
                
            } catch (error) {
                console.error("Import error:", error);
                alert("‚ùå Error importing cards. Make sure it's a valid share URL.");
            }
        }
        
        function exportCardsToFile() {
            const exportData = {
                version: '1.0',
                date: new Date().toISOString(),
                description: 'Cards Against Humanity Collection',
                answers: gameState.cardCollection.answers
                    .filter(card => !card.isDefault && card.enabled)
                    .map(card => card.text),
                questions: gameState.cardCollection.questions
                    .filter(card => !card.isDefault && card.enabled)
                    .map(card => card.text)
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cards-collection-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert("‚úÖ Cards exported to file! You can share this file with friends.");
        }
        
        function importCardsFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const imported = JSON.parse(event.target.result);
                        
                        let addedAnswers = 0;
                        let addedQuestions = 0;
                        
                        if (imported.answers && Array.isArray(imported.answers)) {
                            imported.answers.forEach(answer => {
                                if (!gameState.cardCollection.answers.some(c => 
                                    c.text.toLowerCase() === answer.toLowerCase())) {
                                    gameState.cardCollection.answers.push({
                                        text: answer,
                                        enabled: true,
                                        isDefault: false
                                    });
                                    addedAnswers++;
                                }
                            });
                        }
                        
                        if (imported.questions && Array.isArray(imported.questions)) {
                            imported.questions.forEach(question => {
                                if (!gameState.cardCollection.questions.some(c => 
                                    c.text.toLowerCase() === question.toLowerCase())) {
                                    gameState.cardCollection.questions.push({
                                        text: question,
                                        enabled: true,
                                        isDefault: false
                                    });
                                    addedQuestions++;
                                }
                            });
                        }
                        
                        saveCardCollection();
                        refreshCollection();
                        
                        alert(`‚úÖ Imported ${addedAnswers} new answer cards and ${addedQuestions} new question cards!`);
                    } catch (error) {
                        alert('‚ùå Error importing cards. Make sure it\'s a valid cards file.');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function loadCardsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardsParam = urlParams.get('cards');
            
            if (cardsParam) {
                try {
                    const decoded = decodeURIComponent(atob(cardsParam));
                    const imported = JSON.parse(decoded);
                    
                    let addedAnswers = 0;
                    let addedQuestions = 0;
                    
                    if (imported.a && Array.isArray(imported.a)) {
                        imported.a.forEach(answer => {
                            if (!gameState.cardCollection.answers.some(c => 
                                c.text.toLowerCase() === answer.toLowerCase())) {
                                gameState.cardCollection.answers.push({
                                    text: answer,
                                    enabled: true,
                                    isDefault: false
                                });
                                addedAnswers++;
                            }
                        });
                    }
                    
                    if (imported.q && Array.isArray(imported.q)) {
                        imported.q.forEach(question => {
                            if (!gameState.cardCollection.questions.some(c => 
                                c.text.toLowerCase() === question.toLowerCase())) {
                                gameState.cardCollection.questions.push({
                                    text: question,
                                    enabled: true,
                                    isDefault: false
                                });
                                addedQuestions++;
                            }
                        });
                    }
                    
                    if (addedAnswers > 0 || addedQuestions > 0) {
                        saveCardCollection();
                        setTimeout(() => {
                            alert(`üì• Loaded ${addedAnswers} answer cards and ${addedQuestions} question cards from URL!`);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Failed to load cards from URL:', error);
                }
            }
        }
        
        // ==================== YOUR ORIGINAL SCREEN FUNCTIONS ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            if (screenId === 'collection') {
                refreshCollection();
            } else if (screenId === 'share') {
                updateMenuStats();
            } else if (screenId === 'menu') {
                updateMenuStats();
            }
        }
        
        function switchCollectionTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchCollectionTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
        }
        
        function switchCreateTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchCreateTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'CreateTab').classList.add('active');
        }
        
        function refreshCollection() {
            // Update answer collection
            const answerContainer = document.getElementById('answerCollection');
            if (answerContainer) {
                answerContainer.innerHTML = '';
                
                let enabledAnswers = 0;
                gameState.cardCollection.answers.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card ${card.enabled ? '' : 'disabled'}`;
                    
                    cardDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;">${card.text}</span>
                            <div class="collection-controls">
                                ${card.isDefault ? 
                                    '<span style="color: #666; font-size: 10px;">Default</span>' : 
                                    ''
                                }
                                <button class="${card.enabled ? 'btn-disable' : 'btn-enable'}" 
                                        onclick="toggleCardEnabled('answers', ${index})">
                                    ${card.enabled ? 'Disable' : 'Enable'}
                                </button>
                                ${!card.isDefault ? `
                                    <button class="btn-delete" 
                                            onclick="deleteCard('answers', ${index})">
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    answerContainer.appendChild(cardDiv);
                    
                    if (card.enabled) enabledAnswers++;
                });
                
                document.getElementById('enabledAnswersCount').textContent = enabledAnswers;
                document.getElementById('totalAnswersCount').textContent = gameState.cardCollection.answers.length;
            }
            
            // Update question collection
            const questionContainer = document.getElementById('questionCollection');
            if (questionContainer) {
                questionContainer.innerHTML = '';
                
                let enabledQuestions = 0;
                gameState.cardCollection.questions.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card ${card.enabled ? '' : 'disabled'}`;
                    
                    cardDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 13px;">${card.text}</span>
                            <div class="collection-controls">
                                ${card.isDefault ? 
                                    '<span style="color: #666; font-size: 10px;">Default</span>' : 
                                    ''
                                }
                                <button class="${card.enabled ? 'btn-disable' : 'btn-enable'}" 
                                        onclick="toggleCardEnabled('questions', ${index})">
                                    ${card.enabled ? 'Disable' : 'Enable'}
                                </button>
                                ${!card.isDefault ? `
                                    <button class="btn-delete" 
                                            onclick="deleteCard('questions', ${index})">
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    questionContainer.appendChild(cardDiv);
                    
                    if (card.enabled) enabledQuestions++;
                });
                
                document.getElementById('enabledQuestionsCount').textContent = enabledQuestions;
                document.getElementById('totalQuestionsCount').textContent = gameState.cardCollection.questions.length;
            }
            
            updateMenuStats();
        }
        
        function toggleCardEnabled(type, index) {
            const collection = gameState.cardCollection[type];
            
            if (index >= 0 && index < collection.length) {
                collection[index].enabled = !collection[index].enabled;
                saveCardCollection();
                refreshCollection();
            }
        }
        
        function deleteCard(type, index) {
            const collection = gameState.cardCollection[type];
            
            if (index >= 0 && index < collection.length && !collection[index].isDefault) {
                if (confirm("Are you sure you want to delete this card?")) {
                    collection.splice(index, 1);
                    saveCardCollection();
                    refreshCollection();
                }
            }
        }
        
        function enableAllCards(type) {
            const collection = gameState.cardCollection[type];
            collection.forEach(card => {
                card.enabled = true;
            });
            saveCardCollection();
            refreshCollection();
        }
        
        function returnToMenu() {
            if (gameState.gameActive && gameState.gamePhase !== 'menu') {
                if (confirm("Are you sure you want to quit the game?")) {
                    stopTimer();
                    gameState.gameActive = false;
                    showScreen('menu');
                }
            } else {
                showScreen('menu');
            }
        }
        
        function checkForInvite() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteParam = urlParams.get('invite');
            
            if (inviteParam) {
                try {
                    const decoded = decodeURIComponent(atob(inviteParam));
                    const invite = JSON.parse(decoded);
                    
                    if (invite.type === 'game_invite' && invite.player) {
                        // Auto-fill player name from invite
                        if (document.getElementById('playerName')) {
                            document.getElementById('playerName').value = invite.player;
                        }
                        
                        // Show welcome message
                        setTimeout(() => {
                            alert(`üéÆ Welcome ${invite.player}!\n\nYou've been invited to play Cards Game!\n\nStart a game with bots or wait for multiplayer support.`);
                        }, 1000);
                        
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (error) {
                    console.error("Failed to parse invite:", error);
                }
            }
        }
        
        // ==================== NEW MULTIPLAYER FUNCTIONS ====================
        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('Username must be at least 3 characters', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                // In production, replace with actual API call
                const response = await mockApiCall('/api/register', {
                    username,
                    email: email || null,
                    password
                });
                
                if (response.success) {
                    showNotification('Account created successfully!', 'success');
                    // Auto login after registration
                    await login(username, password);
                }
            } catch (error) {
                showNotification(error.message || 'Registration failed', 'error');
            }
        }
        
        async function login(username = null, password = null) {
            const loginUsername = username || document.getElementById('loginUsername').value.trim();
            const loginPassword = password || document.getElementById('loginPassword').value;
            
            if (!loginUsername || !loginPassword) {
                showNotification('Please enter username and password', 'error');
                return;
            }
            
            try {
                // In production, replace with actual API call
                const response = await mockApiCall('/api/login', {
                    username: loginUsername,
                    password: loginPassword
                });
                
                if (response.success) {
                    gameState.user = response.user;
                    gameState.token = response.token;
                    gameState.isGuest = false;
                    
                    // Save user data locally
                    localStorage.setItem('currentUser', JSON.stringify({
                        user: gameState.user,
                        token: gameState.token,
                        cardCollection: gameState.cardCollection
                    }));
                    
                    // Initialize user data
                    initializeCardCollection();
                    
                    // Connect to WebSocket
                    connectWebSocket();
                    
                    showScreen('menu');
                    showNotification(`Welcome back, ${gameState.user.username}!`, 'success');
                }
            } catch (error) {
                showNotification(error.message || 'Login failed', 'error');
            }
        }
        
        function quickLogin() {
            const guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
            gameState.user = {
                id: guestId,
                username: 'Guest_' + Math.floor(Math.random() * 1000),
                isGuest: true
            };
            gameState.token = null;
            gameState.isGuest = true;
            
            initializeCardCollection();
            showScreen('menu');
            showNotification('Playing as guest - data saved locally only', 'warning');
        }
        
        function logout() {
            if (gameState.socket) {
                gameState.socket.close();
            }
            
            gameState.user = null;
            gameState.token = null;
            gameState.isGuest = false;
            gameState.currentRoom = null;
            
            localStorage.removeItem('currentUser');
            
            showScreen('auth');
            showNotification('Logged out successfully', 'success');
        }
        
        function connectWebSocket() {
            if (gameState.isGuest) {
                console.log('Guest mode - WebSocket disabled');
                return;
            }
            
            const wsUrl = 'ws://localhost:3000'; // Change to your server URL
            gameState.socket = new WebSocket(wsUrl);
            
            gameState.socket.onopen = () => {
                console.log('WebSocket connected');
                // Authenticate with server
                gameState.socket.send(JSON.stringify({
                    type: 'auth',
                    token: gameState.token,
                    user: gameState.user
                }));
            };
            
            gameState.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            gameState.socket.onclose = () => {
                console.log('WebSocket disconnected');
                setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
            };
            
            gameState.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'auth_success':
                    console.log('Authenticated with server');
                    break;
                    
                case 'online_players':
                    gameState.onlinePlayers = data.players;
                    updateOnlinePlayersList();
                    break;
                    
                case 'friends_update':
                    gameState.friends = data.friends;
                    updateFriendsList();
                    break;
                    
                case 'room_created':
                    joinRoom(data.room);
                    break;
                    
                case 'room_joined':
                    joinRoom(data.room);
                    break;
                    
                case 'room_updated':
                    updateRoom(data.room);
                    break;
                    
                case 'room_message':
                    addRoomMessage(data.message);
                    break;
                    
                case 'game_start':
                    startMultiplayerGame(data.game);
                    break;
                    
                case 'game_update':
                    updateMultiplayerGame(data.update);
                    break;
                    
                case 'invite_received':
                    showInviteNotification(data.invite);
                    break;
                    
                case 'notification':
                    showNotification(data.message, data.level);
                    break;
            }
        }
        
        function createPrivateRoom() {
            const roomName = document.getElementById('roomName').value || 'My Game Room';
            const maxPlayers = parseInt(document.getElementById('roomMaxPlayers').value);
            const pointsToWin = parseInt(document.getElementById('roomPointsToWin').value);
            const enableTimer = document.getElementById('roomEnableTimer').checked;
            const allowCardCreation = document.getElementById('roomAllowCardCreation').checked;
            const addBots = document.getElementById('roomAddBots').checked;
            
            const roomData = {
                name: roomName,
                maxPlayers,
                pointsToWin,
                enableTimer,
                allowCardCreation,
                isPublic: false,
                host: gameState.user.id,
                settings: {
                    addBots
                }
            };
            
            if (gameState.socket) {
                gameState.socket.send(JSON.stringify({
                    type: 'create_room',
                    room: roomData
                }));
            } else {
                // Fallback for local/guest mode
                const roomCode = generateRoomCode();
                const room = {
                    ...roomData,
                    id: 'local_' + Date.now(),
                    code: roomCode,
                    players: [{
                        id: gameState.user.id,
                        username: gameState.user.username,
                        isHost: true,
                        isReady: false
                    }],
                    createdAt: new Date().toISOString()
                };
                
                gameState.currentRoom = room;
                gameState.isHost = true;
                showRoomLobby(room);
            }
        }
        
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function joinRoom(room) {
            gameState.currentRoom = room;
            gameState.isHost = room.host === gameState.user.id;
            gameState.readyPlayers.clear();
            
            showRoomLobby(room);
        }
        
        function joinRoomByCode() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!code) {
                showNotification('Please enter a room code', 'error');
                return;
            }
            
            if (gameState.socket) {
                gameState.socket.send(JSON.stringify({
                    type: 'join_room',
                    code: code
                }));
            } else {
                showNotification('Please login to join rooms', 'error');
            }
        }
        
        function showRoomLobby(room) {
            document.getElementById('lobbyRoomName').textContent = room.name;
            document.getElementById('lobbyRoomCode').textContent = room.code;
            document.getElementById('lobbyMaxPlayers').textContent = room.maxPlayers;
            document.getElementById('lobbyInviteCode').textContent = room.code;
            
            // Show/hide host controls
            document.getElementById('hostControls').style.display = gameState.isHost ? 'block' : 'none';
            
            updateLobbyPlayers(room.players);
            showScreen('roomLobby');
        }
        
        function updateLobbyPlayers(players) {
            const container = document.getElementById('lobbyPlayersList');
            if (!container) return;
            
            container.innerHTML = '';
            document.getElementById('lobbyPlayerCount').textContent = players.length;
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-online';
                
                const isReady = gameState.readyPlayers.has(player.id);
                
                playerDiv.innerHTML = `
                    <div>
                        <span class="status-indicator ${isReady ? 'status-online' : 'status-ingame'}"></span>
                        <span style="font-weight: ${player.isHost ? 'bold' : 'normal'}">
                            ${player.username} ${player.isHost ? 'üëë' : ''}
                        </span>
                    </div>
                    <div>
                        ${isReady ? '‚úÖ Ready' : '‚è≥ Not Ready'}
                        ${gameState.isHost && !player.isHost ? 
                            `<button class="small-btn btn-danger" onclick="kickPlayer('${player.id}')">Kick</button>` : 
                            ''
                        }
                    </div>
                `;
                
                container.appendChild(playerDiv);
            });
        }
        
        function readyToggle() {
            const button = document.getElementById('readyButton');
            const isReady = button.textContent.includes('Ready');
            
            if (isReady) {
                button.innerHTML = '‚è≥ Not Ready';
                button.classList.remove('btn-success');
                button.classList.add('btn-warning');
                gameState.readyPlayers.delete(gameState.user.id);
            } else {
                button.innerHTML = '‚úÖ Ready';
                button.classList.remove('btn-warning');
                button.classList.add('btn-success');
                gameState.readyPlayers.add(gameState.user.id);
            }
            
            if (gameState.socket && gameState.currentRoom) {
                gameState.socket.send(JSON.stringify({
                    type: 'player_ready',
                    roomId: gameState.currentRoom.id,
                    isReady: !isReady
                }));
            }
        }
        
        function leaveRoom() {
            if (gameState.socket && gameState.currentRoom) {
                gameState.socket.send(JSON.stringify({
                    type: 'leave_room',
                    roomId: gameState.currentRoom.id
                }));
            }
            
            gameState.currentRoom = null;
            gameState.isHost = false;
            gameState.readyPlayers.clear();
            showScreen('menu');
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f44336' : 
                                          type === 'success' ? '#4CAF50' : 
                                          type === 'warning' ? '#FF9800' : '#333';
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px;">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; font-size: 16px; cursor: pointer; margin-left: 10px;">
                        √ó
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function mockApiCall(endpoint, data) {
            // Simulate API call delay
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (endpoint === '/api/register') {
                        // Mock registration
                        const user = {
                            id: 'user_' + Date.now(),
                            username: data.username,
                            email: data.email,
                            createdAt: new Date().toISOString()
                        };
                        
                        localStorage.setItem('user_' + data.username, JSON.stringify({
                            user,
                            password: data.password // In real app, this would be hashed
                        }));
                        
                        resolve({
                            success: true,
                            user,
                            token: 'mock_jwt_token_' + Date.now()
                        });
                    } else if (endpoint === '/api/login') {
                        // Mock login
                        const stored = localStorage.getItem('user_' + data.username);
                        if (!stored) {
                            reject(new Error('User not found'));
                            return;
                        }
                        
                        const userData = JSON.parse(stored);
                        if (userData.password !== data.password) {
                            reject(new Error('Invalid password'));
                            return;
                        }
                        
                        resolve({
                            success: true,
                            user: userData.user,
                            token: 'mock_jwt_token_' + Date.now()
                        });
                    } else {
                        reject(new Error('API endpoint not found'));
                    }
                }, 500);
            });
        }
        
        function updateOnlinePlayersList() {
            const container = document.getElementById('onlinePlayersList');
            if (!container) return;
            
            if (gameState.onlinePlayers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 13px;">No players online</p>';
                return;
            }
            
            container.innerHTML = '';
            gameState.onlinePlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-online';
                
                playerDiv.innerHTML = `
                    <div>
                        <span class="status-indicator ${player.status === 'online' ? 'status-online' : 'status-ingame'}"></span>
                        <span>${player.username}</span>
                    </div>
                    <div>
                        <button class="small-btn btn-secondary" onclick="sendFriendRequest('${player.username}')">
                            Add
                        </button>
                        <button class="small-btn" onclick="inviteToGame('${player.id}')">
                            Invite
                        </button>
                    </div>
                `;
                
                container.appendChild(playerDiv);
            });
        }
        
        function updateFriendsList() {
            const container = document.getElementById('friendsList');
            if (!container) return;
            
            if (gameState.friends.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 13px;">No friends yet</p>';
                return;
            }
            
            container.innerHTML = '';
            gameState.friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                
                friendDiv.innerHTML = `
                    <div>
                        <span class="status-indicator ${friend.online ? 'status-online' : 'status-offline'}"></span>
                        <span>${friend.username}</span>
                    </div>
                    <div>
                        ${friend.online ? 
                            `<button class="small-btn btn-success" onclick="inviteToGame('${friend.id}')">
                                Invite
                            </button>` : 
                            '<span style="color: #999; font-size: 11px;">Offline</span>'
                        }
                        <button class="small-btn btn-danger" onclick="removeFriend('${friend.id}')">
                            Remove
                        </button>
                    </div>
                `;
                
                container.appendChild(friendDiv);
            });
        }
        
        function switchMenuTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchMenuTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            if (tabId === 'social' && gameState.socket) {
                // Request fresh online players list
                gameState.socket.send(JSON.stringify({
                    type: 'get_online_players'
                }));
            }
        }
        
        // Initialize on load
        window.onload = function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    gameState.user = userData.user;
                    gameState.token = userData.token;
                    
                    if (userData.cardCollection) {
                        gameState.cardCollection = userData.cardCollection;
                    } else {
                        initializeCardCollection();
                    }
                    
                    showScreen('menu');
                    connectWebSocket();
                } catch (error) {
                    console.error('Failed to load saved user:', error);
                    showScreen('auth');
                }
            } else {
                showScreen('auth');
                initializeCardCollection();
            }
            
            loadCardsFromURL();
            checkForInvite();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (gameState.gamePhase === "playing" && !gameState.isJudge && !gameState.playerHasSubmitted) {
                    const key = e.key;
                    const number = parseInt(key);
                    
                    if (number >= 1 && number <= 10) {
                        selectCard(number - 1);
                    }
                }
                
                if (e.key === 'Escape' && !document.getElementById('authScreen').classList.contains('active')) {
                    if (confirm('Return to main menu?')) {
                        showScreen('menu');
                    }
                }
            });
        };
        
        // Export all functions to global scope
        window.showScreen = showScreen;
        window.switchMenuTab = switchMenuTab;
        window.switchCollectionTab = switchCollectionTab;
        window.switchCreateTab = switchCreateTab;
        window.login = login;
        window.register = register;
        window.quickLogin = quickLogin;
        window.logout = logout;
        window.createPrivateRoom = createPrivateRoom;
        window.joinRoomByCode = joinRoomByCode;
        window.readyToggle = readyToggle;
        window.leaveRoom = leaveRoom;
        window.startSolitaireGame = startSolitaireGame;
        window.createCard = createCard;
        window.addCreateBlank = addCreateBlank;
        window.removeCreateBlank = removeCreateBlank;
        window.generateShareLink = generateShareLink;
        window.copyShareLink = copyShareLink;
        window.importFromUrl = importFromUrl;
        window.exportCardsToFile = exportCardsToFile;
        window.importCardsFromFile = importCardsFromFile;
        window.generateGameInviteLink = generateGameInviteLink;
        window.copyGameInviteLink = copyGameInviteLink;
        window.toggleCardEnabled = toggleCardEnabled;
        window.deleteCard = deleteCard;
        window.enableAllCards = enableAllCards;
        window.submitCard = submitCard;
        window.forceBotSubmission = forceBotSubmission;
        window.returnToMenu = returnToMenu;
        window.forceRandomWinner = forceRandomWinner;
        window.continueToNextRound = continueToNextRound;
    </script>
</body>
  </html>
